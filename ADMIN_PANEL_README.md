# Административная панель

Полноценная админ-панель для управления проектом FOHOW.

## Установка и настройка

### 1. Применение миграции базы данных

Миграция добавляет поле `role` в таблицу `users` и устанавливает роль администратора для указанного пользователя.

```bash
# Применить миграцию
psql -U $DB_USER -d $DB_NAME -f api/migrations/009_add_admin_role.sql
```

Или если у вас настроены переменные окружения:

```bash
# Загрузите переменные из .env
source .env

# Применить миграцию
psql -U $DB_USER -h $DB_HOST -d $DB_NAME -f api/migrations/009_add_admin_role.sql
```

### 2. Настройка первого администратора

По умолчанию миграция устанавливает роль администратора для пользователя с email `sergeixmao@gmail.com`.

Если вам нужно назначить администратором другого пользователя, выполните SQL запрос:

```sql
UPDATE users SET role = 'admin' WHERE email = 'ваш_email@example.com';
```

Или через psql:

```bash
psql -U $DB_USER -d $DB_NAME -c "UPDATE users SET role = 'admin' WHERE email = 'ваш_email@example.com';"
```

## Функциональность

### Backend (API)

**Эндпоинты админ-панели** (все требуют авторизации и роли `admin`):

#### Управление пользователями
- `GET /api/admin/users` - Список пользователей с пагинацией и поиском
  - Query параметры: `page`, `limit`, `search`, `sortBy`, `sortOrder`
- `GET /api/admin/users/:userId` - Детальная информация о пользователе
- `PATCH /api/admin/users/:userId/role` - Изменить роль пользователя
- `PATCH /api/admin/users/:userId/plan` - Изменить тарифный план
- `DELETE /api/admin/users/:userId` - Удалить пользователя

#### Статистика и мониторинг
- `GET /api/admin/stats` - Общая статистика системы
- `GET /api/admin/logs` - Системные логи с пагинацией
  - Query параметры: `page`, `limit`, `level`

#### Управление сессиями
- `DELETE /api/admin/sessions/:sessionId` - Завершить сессию
- `DELETE /api/admin/users/:userId/sessions` - Завершить все сессии пользователя

### Frontend

**Компоненты:**
- `AdminPanel.vue` - Главная страница админ-панели с табами
- `AdminStats.vue` - Статистика системы
- `AdminUsers.vue` - Управление пользователями
- `AdminLogs.vue` - Просмотр системных логов

**Маршрут:** `/admin` (доступен только администраторам)

### Возможности админ-панели

#### 1. Статистика
- Общая статистика пользователей (всего, новых за неделю/месяц)
- Статистика контента (доски, заметки, стикеры, комментарии)
- Активность пользователей (сессии, активные за час/сутки)
- Распределение по тарифным планам
- График регистраций за последние 30 дней

#### 2. Управление пользователями
- Поиск по email, username или ID
- Сортировка по различным полям
- Просмотр детальной информации о пользователе
- Изменение роли (user/admin)
- Изменение тарифного плана с указанием длительности
- Завершение всех сессий пользователя
- Удаление пользователя (с двойным подтверждением)

#### 3. Системные логи
- Просмотр логов с пагинацией
- Фильтрация по уровню (info, warning, error)
- Просмотр контекста ошибок
- Временные метки в формате локального времени

## Безопасность

### Backend
1. **Middleware `requireAdmin`** проверяет роль пользователя при каждом запросе
2. **Проверка в middleware `authenticateToken`** загружает роль из БД
3. **Защита от самоизменения** - администратор не может изменить свою роль
4. **Двойное подтверждение** при удалении пользователя
5. **Логирование всех действий** администратора

### Frontend
1. **Router guard** проверяет роль перед доступом к `/admin`
2. **Редирект на `/boards`** если пользователь не администратор
3. **Проверка на уровне компонента** при монтировании

## Разработка

### Структура файлов

```
api/
├── migrations/
│   └── 009_add_admin_role.sql          # Миграция роли администратора
├── middleware/
│   ├── auth.js                         # Базовая авторизация (обновлен)
│   └── requireAdmin.js                 # Проверка роли администратора
├── routes/
│   └── admin.js                        # Эндпоинты админ-панели
└── server.js                           # Регистрация маршрутов (обновлен)

src/
├── components/
│   └── Admin/
│       ├── AdminStats.vue              # Компонент статистики
│       ├── AdminUsers.vue              # Компонент управления пользователями
│       └── AdminLogs.vue               # Компонент просмотра логов
├── stores/
│   ├── admin.js                        # Store для админ-панели
│   └── auth.js                         # Store авторизации (обновлен)
├── views/
│   └── AdminPanel.vue                  # Главная страница админ-панели
└── router/
    └── index.js                        # Маршруты (обновлен)
```

### Добавление нового функционала

#### Backend
1. Добавить эндпоинт в `api/routes/admin.js`
2. Использовать middleware `[authenticateToken, requireAdmin]`
3. Добавить логирование действий

#### Frontend
1. Добавить метод в `src/stores/admin.js`
2. Добавить UI в соответствующий компонент
3. Обработать ошибки и отобразить уведомления

## Тестирование

### Проверка прав доступа

```bash
# 1. Попытка доступа без авторизации (должно вернуть 401)
curl -X GET http://localhost:4000/api/admin/stats

# 2. Попытка доступа с токеном обычного пользователя (должно вернуть 403)
curl -X GET http://localhost:4000/api/admin/stats \
  -H "Authorization: Bearer YOUR_USER_TOKEN"

# 3. Доступ с токеном администратора (должно вернуть статистику)
curl -X GET http://localhost:4000/api/admin/stats \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### Проверка функциональности

1. Войдите под учетной записью администратора
2. Перейдите на `/admin`
3. Проверьте каждую вкладку:
   - Статистика: должны отображаться данные
   - Пользователи: должен работать поиск и сортировка
   - Логи: должны загружаться логи с фильтрацией

## Производительность

### Оптимизации
- Пагинация на всех списках (пользователи, логи)
- Индексы на поле `role` в таблице `users`
- Ленивая загрузка компонентов админ-панели
- Дебаунсинг поиска (500мс задержка)

### Рекомендации
- Лимит пользователей на странице: 50
- Лимит логов на странице: 100
- Регулярная очистка старых логов (рекомендуется хранить не более 30 дней)

## Troubleshooting

### Ошибка "Доступ запрещен"
1. Проверьте, что миграция применена: `SELECT * FROM users WHERE role = 'admin';`
2. Убедитесь, что пользователь вошел заново после назначения роли
3. Проверьте токен в localStorage содержит правильного пользователя

### Не загружаются данные
1. Проверьте консоль браузера на наличие ошибок
2. Проверьте сетевые запросы во вкладке Network
3. Убедитесь, что backend запущен и доступен

### Ошибки при применении миграции
1. Проверьте, что таблица `users` существует
2. Убедитесь, что у вас есть права на ALTER TABLE
3. Проверьте, что пользователь с указанным email существует

## Дальнейшее развитие

### Планируемые функции
- [ ] Экспорт данных (CSV, JSON)
- [ ] Массовые операции над пользователями
- [ ] Настройка тарифных планов через UI
- [ ] Управление промокодами
- [ ] Расширенная аналитика и графики
- [ ] Система уведомлений администратора
- [ ] Журнал действий администратора
- [ ] Управление правами (дополнительные роли)

## Поддержка

При возникновении проблем или вопросов обращайтесь к документации проекта или создайте issue в репозитории.
