# Архитектура проекта FOHOW Interactive Board

## Обзор системы

```
┌─────────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                             │
│                      (браузер/телефон)                          │
└─────────────────────────┬───────────────────────────────────────┘
                          │ HTTPS
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      СЕРВЕР BEGET                               │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Nginx (reverse proxy)                │    │
│  │                     порт 443 (HTTPS)                    │    │
│  └────────────────────────┬────────────────────────────────┘    │
│                           │                                     │
│          ┌────────────────┴────────────────┐                    │
│          ▼                                 ▼                    │
│  ┌───────────────────┐           ┌─────────────────────┐        │
│  │   Static Files    │           │   Node.js API       │        │
│  │   /dist/*         │           │   порт 4000         │        │
│  │   (Frontend)      │           │   (Backend)         │        │
│  └───────────────────┘           └──────────┬──────────┘        │
│                                             │                   │
└─────────────────────────────────────────────┼───────────────────┘
                                              │
                    ┌─────────────────────────┼─────────────────────────┐
                    │                         │                         │
                    ▼                         ▼                         ▼
        ┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐
        │   PostgreSQL      │    │   Yandex.Disk     │    │   Telegram Bot    │
        │   (SQL сервер     │    │   (хранение       │    │   (уведомления)   │
        │    Beget)         │    │    файлов)        │    │                   │
        └───────────────────┘    └───────────────────┘    └───────────────────┘
```

---

## Компоненты системы

### Frontend (Vue.js 3)

**Расположение:** `/var/www/FOHOW-proekt-v3/src/`
**Сборка:** `/var/www/FOHOW-proekt-v3/dist/`

| Слой | Папка | Назначение |
|------|-------|------------|
| Views | `src/views/` | Страницы (роуты) |
| Components | `src/components/` | UI компоненты |
| Composables | `src/composables/` | Переиспользуемая логика |
| Stores | `src/stores/` | Состояние приложения (Pinia) |
| Router | `src/router/` | Маршрутизация |
| Services | `src/services/` | API клиенты |

**Ключевые технологии:**
- Vue.js 3 (Composition API)
- Pinia (state management)
- Vue Router
- Vite (сборщик)
- Canvas API (рендеринг изображений)

---

### Backend (Node.js + Fastify)

**Расположение:** `/var/www/FOHOW-proekt-v3/api/`

| Слой | Папка | Назначение |
|------|-------|------------|
| Entry | `server.js` | Точка входа, middleware |
| Routes | `routes/` | HTTP endpoints |
| Services | `services/` | Бизнес-логика |

**Ключевые технологии:**
- Node.js
- Fastify (веб-фреймворк)
- PostgreSQL (через pg)
- node-cron (фоновые задачи)

---

### База данных (PostgreSQL)

**Расположение:** Отдельный SQL-сервер Beget

**Основные таблицы:**

| Таблица | Назначение |
|---------|------------|
| `users` | Пользователи системы |
| `boards` | Доски (содержимое в JSONB) |
| `subscriptions` | Подписки пользователей |
| `images` | Метаданные изображений пользователей |
| `shared_images` | Общая библиотека изображений |
| `notes` | Заметки к карточкам |
| `stickers` | Стикеры на досках |
| `user_sessions` | Сессии пользователей |
| `email_verification_codes` | Коды подтверждения email |

---

### Внешние сервисы

| Сервис | Назначение | Интеграция |
|--------|------------|------------|
| **Yandex.Disk** | Хранение изображений | REST API |
| **Yandex Vision** | Модерация контента | REST API |
| **Telegram Bot** | Уведомления админам | Bot API |
| **SMTP Beget** | Email верификация | Nodemailer |

---

## Потоки данных

### Загрузка изображения

```
1. Пользователь выбирает файл
           │
2. Frontend отправляет на /api/images/upload
           │
3. Backend получает файл
           │
4. Backend загружает на Yandex.Disk
           │
5. Backend сохраняет метаданные в PostgreSQL
           │
6. Backend возвращает URL изображения
           │
7. Frontend показывает изображение на холсте
```

### Сохранение доски

```
1. Пользователь нажимает "Сохранить"
           │
2. Frontend собирает состояние (карточки, соединения, изображения)
           │
3. Frontend отправляет JSON на /api/boards/:id
           │
4. Backend валидирует данные
           │
5. Backend сохраняет в PostgreSQL (поле content типа JSONB)
           │
6. Backend создаёт миниатюру (thumbnail)
           │
7. Backend возвращает успех
           │
8. Frontend показывает "Сохранено!"
```

---

## Модель подписок

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   GUEST     │ ──▶│    DEMO     │ ──▶ │ INDIVIDUAL  │ ──▶ │  PREMIUM    │
│  (базовый)  │     │  (7 дней)   │     │  (платный)  │     │  (макс.)    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
     │                    │                   │                   │
     ▼                    ▼                   ▼                   ▼
  1 доска            3 доски            10 досок           Без лимита
  Базовые           + Экспорт          + Библиотека       + Всё
  функции           + Шаринг           + Коллаборация     + Приоритет
```

---

## Безопасность

### Аутентификация
- JWT токены
- Refresh токены
- Email верификация

### Авторизация
- Роли: user, admin
- Проверка владения ресурсами
- Rate limiting

### Защита данных
- HTTPS (SSL сертификат)
- Хеширование паролей (bcrypt)
- Санитизация входных данных

---

## Мониторинг

### Логи
```bash
# Backend логи
journalctl -u fohow-api -f

# Nginx логи
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### Cron задачи
- Очистка старых сессий (каждый час)
- Закрытие демо-периодов (ежедневно)
- Удаление заблокированных досок (ежедневно)
- Очистка кодов подтверждения (каждые 6 часов)

---

## Масштабирование (будущее)

При росте до 10,000+ пользователей:

1. **Горизонтальное масштабирование Backend**
   - Несколько инстансов Node.js
   - Load balancer

2. **Кэширование**
   - Redis для сессий
   - CDN для статики

3. **База данных**
   - Read replicas
   - Connection pooling

4. **Очереди задач**
   - Bull/Redis для фоновых задач
   - Отложенная обработка изображений
