# Деплой (Развёртывание на сервер)

## Быстрая инструкция

```bash
# 1. Подключиться к серверу
ssh root@<IP-адрес-сервера>

# 2. Перейти в папку проекта
cd /var/www/FOHOW-proekt-v3

# 3. Скачать новый код
git pull

# 4. Собрать frontend
npm run build

# 5. Перезапустить backend
systemctl restart fohow-api

# 6. Проверить что всё работает
systemctl status fohow-api
```

---

## Подробная инструкция

### Шаг 1: Подключение к серверу

```bash
ssh root@<IP-адрес-сервера>
```

Введи пароль когда попросят.

**Если не подключается:**
- Проверь IP-адрес
- Проверь интернет-соединение
- Убедись что сервер работает (панель Beget)

---

### Шаг 2: Переход в папку проекта

```bash
cd /var/www/FOHOW-proekt-v3
```

**Проверка:** Команда `pwd` должна показать `/var/www/FOHOW-proekt-v3`

---

### Шаг 3: Скачивание нового кода

```bash
git pull
```

**Возможные ответы:**

✅ `Already up to date.` — Код уже актуальный, ничего скачивать не нужно.

✅ `Fast-forward... 5 files changed` — Код обновился, всё хорошо.

❌ `error: Your local changes...` — Есть локальные изменения. Решение:
```bash
git stash        # Спрятать изменения
git pull         # Скачать новое
git stash pop    # Вернуть изменения (если нужно)
```

❌ `CONFLICT` — Конфликт. Позови программиста.

---

### Шаг 4: Сборка frontend

```bash
npm run build
```

Это занимает 5-15 секунд. В конце увидишь:

```
✓ built in 7.80s
```

**Возможные проблемы:**

❌ `npm ERR!` — Ошибка сборки. Скопируй текст ошибки и отправь программисту.

⚠️ `Some chunks are larger than 500 kB` — Это предупреждение, не ошибка. Можно игнорировать.

---

### Шаг 5: Перезапуск backend

```bash
systemctl restart fohow-api
```

Команда выполняется молча. Если ничего не вывело — значит всё хорошо.

---

### Шаг 6: Проверка статуса

```bash
systemctl status fohow-api
```

**Хороший ответ:**
```
● fohow-api.service - FOHOW Interactive Board API
     Active: active (running) since ...
```

**Плохой ответ:**
```
● fohow-api.service
     Active: failed (Result: exit-code)
```

Если `failed` — смотри логи:
```bash
journalctl -u fohow-api -n 50
```

---

## Проверка после деплоя

1. Открой сайт в браузере
2. Очисти кэш: `Ctrl+Shift+R` (или `Cmd+Shift+R` на Mac)
3. Проверь:
   - [ ] Страница загружается
   - [ ] Можно войти в аккаунт
   - [ ] Доски открываются
   - [ ] Холст работает (можно двигать карточки)

---

## Откат изменений

Если после деплоя что-то сломалось:

```bash
# Посмотреть последние коммиты
git log --oneline -10

# Откатиться на предыдущий коммит
git checkout <хеш-коммита>

# Пересобрать
npm run build

# Перезапустить
systemctl restart fohow-api
```

**Важно:** После отката сообщи программисту, чтобы он исправил проблему.

---

## Полезные команды

### Логи сервера (последние 100 строк)
```bash
journalctl -u fohow-api -n 100
```

### Логи в реальном времени
```bash
journalctl -u fohow-api -f
```
(Нажми `Ctrl+C` чтобы выйти)

### Проверка места на диске
```bash
df -h
```

### Проверка памяти
```bash
free -h
```

### Проверка процессов
```bash
htop
```
(Нажми `q` чтобы выйти)

---

## Структура на сервере

```
/var/www/FOHOW-proekt-v3/
├── src/              # Исходный код frontend
├── api/              # Исходный код backend
├── dist/             # Собранный frontend (создаётся npm run build)
├── node_modules/     # Зависимости
├── package.json      # Конфигурация проекта
└── .env              # Секреты (НЕ КОММИТИТЬ!)

/etc/systemd/system/
└── fohow-api.service # Конфигурация сервиса
```

---

## Частые проблемы

### Сайт показывает старую версию
**Решение:** Очисти кэш браузера (`Ctrl+Shift+R`)

### "502 Bad Gateway"
**Причина:** Backend не запущен
**Решение:**
```bash
systemctl status fohow-api  # Проверить статус
systemctl restart fohow-api # Перезапустить
```

### "Cannot find module..."
**Причина:** Не установлены зависимости
**Решение:**
```bash
npm install
npm run build
systemctl restart fohow-api
```

### Сервер не отвечает по SSH
**Причина:** Сервер завис или перегружен
**Решение:** Перезагрузи сервер через панель Beget
