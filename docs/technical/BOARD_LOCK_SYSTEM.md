# Система Soft/Hard блокировки досок

## Обзор

Система блокировки досок предназначена для управления доступом к доскам при превышении лимитов тарифного плана. Вместо полной блокировки аккаунта, система применяет **по-досочную** блокировку с плавным переходом от полного доступа к удалению.

## Статусы блокировки

| Статус | Описание | Доступ | Таймер |
|--------|----------|--------|--------|
| `active` | Доска активна | Полный доступ | - |
| `soft_lock` | Режим только для чтения | Просмотр без редактирования | 14 дней до `hard_lock` |
| `hard_lock` | Полная блокировка | Недоступна | 14 дней до удаления |

## Логика работы

### При понижении тарифа (downgrade)

1. Пользователь переводится на тариф Guest (лимит 3 доски)
2. Все доски сортируются по дате изменения (`updated_at DESC`)
3. Первые N досок (в пределах лимита) остаются `active`
4. Остальные доски переводятся в `soft_lock` с таймером 14 дней

### Пример:
- У пользователя 10 досок, лимит тарифа = 3
- 3 самые свежие доски остаются `active`
- 7 старых досок получают статус `soft_lock`

### Ежедневная обработка (cron)

Запускается ежедневно в 03:30 МСК:

1. **soft_lock → hard_lock**: Доски в `soft_lock` более 14 дней переводятся в `hard_lock`
2. **hard_lock → удаление**: Доски в `hard_lock` более 14 дней удаляются

## Структура БД

Поля в таблице `boards`:

```sql
lock_status ENUM('active', 'soft_lock', 'hard_lock') DEFAULT 'active'
lock_timer_started_at TIMESTAMP -- дата начала текущего статуса блокировки
```

## Backend API

### Сервис `api/services/boardLockService.js`

#### `recalcUserBoardLocks(userId)`
Пересчитывает статусы блокировок для всех досок пользователя.

```javascript
const { unlocked, softLocked } = await recalcUserBoardLocks(userId);
```

#### `processDailyLocks()`
Ежедневная обработка таймеров блокировок.

```javascript
const { toHardLock, deleted } = await processDailyLocks();
```

#### `getBoardLockInfo(boardId)`
Получить информацию о блокировке конкретной доски.

#### `unlockAllUserBoards(userId)`
Разблокировать все доски пользователя (при апгрейде тарифа).

### API Endpoints

#### `GET /api/boards`
Возвращает список досок с полями:
- `lock_status` - статус блокировки
- `daysUntilBlock` - дней до `hard_lock` (для `soft_lock`)
- `daysUntilDelete` - дней до удаления (для `hard_lock`)

#### `GET /api/boards/:id`
- `soft_lock`: возвращает `readOnly: true`
- `hard_lock`: возвращает `403 Forbidden`

#### `PUT /api/boards/:id`
- `soft_lock` или `hard_lock`: возвращает `403 Forbidden`

#### `DELETE /api/boards/:id`
- Удаление разрешено для всех статусов (позволяет освободить место)

## Frontend

### BoardsList.vue

Визуализация статусов:

1. **Soft Lock** - оранжевый оверлей с таймером "Блокировка через N дн."
2. **Hard Lock** - красный оверлей с таймером "Удаление через N дн."

Оба статуса отображают кнопку `[?]` для показа информационного модального окна.

### CanvasBoard.vue

- `isReadOnly` передаётся через `provide` дочерним компонентам
- Для `soft_lock` досок отключается редактирование карточек и стикеров
- Показывается toast-уведомление "Режим только для чтения"

### Board Store (Pinia)

Новые поля в `useBoardStore`:
- `isReadOnly` - флаг режима только для чтения
- `lockStatus` - статус блокировки текущей доски
- `daysUntilBlock` - дней до полной блокировки

## Cron-задачи

Файл: `api/cron/tasks.js`

Задача 8: Обработка Soft/Hard Lock досок
- Расписание: ежедневно в 03:30 МСК
- Действия:
  - `soft_lock > 14 дней` → `hard_lock`
  - `hard_lock > 14 дней` → удаление

## Интеграция со скриптом понижения

Файл: `scripts/downgrade_expired.js`

После понижения тарифа автоматически вызывается `recalcUserBoardLocks()` для пересчёта блокировок.

## Сценарии использования

### Сценарий 1: Истечение подписки

1. Подписка Premium истекает
2. Пользователь переводится на Guest (лимит 3 доски)
3. У пользователя 10 досок
4. 3 самые свежие остаются `active`
5. 7 старых получают `soft_lock`
6. Через 14 дней `soft_lock` → `hard_lock`
7. Ещё через 14 дней `hard_lock` → удаление

### Сценарий 2: Удаление заблокированной доски

1. Пользователь видит доску в `soft_lock`
2. Удаляет её для освобождения места
3. Одна из `soft_lock` досок автоматически переходит в `active` (при следующем пересчёте)

### Сценарий 3: Продление подписки

1. Пользователь продлевает подписку Premium
2. Вызывается `unlockAllUserBoards()`
3. Все доски переходят в `active`

## Безопасность

- Администраторы игнорируют все блокировки
- Проверка `lock_status` выполняется на стороне сервера
- Таймеры хранятся в БД, не зависят от клиента

## Логирование

Все операции логируются в консоль и таблицу `system_logs`:
- `process_daily_locks_completed` - успешная обработка
- `process_daily_locks_failed` - ошибка обработки

## Миграция

Поля `lock_status` и `lock_timer_started_at` уже добавлены в БД вручную. SQL-миграции не требуются.
