# Система блокировки досок (Board Lock System)

## Обзор
Система ограничивает доступ к доскам на основе лимитов тарифного плана пользователя.
Лимиты определяются в таблице `subscription_plans` (колонка `features`):
- `max_boards`: Максимальное количество активных досок.
- `max_objects`: Максимальное количество объектов на одной доске.

## Статусы блокировки (`lock_status`)
1. **active** (NULL или 'active'): Доска полностью доступна.
2. **soft_lock**: Доступна только для чтения.
   - Устанавливается при превышении лимитов.
   - Запускается таймер (`lock_timer_started_at`).
   - Через 14 дней переходит в `hard_lock`.
3. **hard_lock**: Доска недоступна (скрыта контент, показана заглушка).
   - Устанавливается автоматически из `soft_lock`.
   - Через 14 дней доска удаляется.

## Алгоритм пересчета блокировок (`recalcUserBoardLocks`)

Пересчет запускается при:
- Изменении тарифа пользователя.
- Создании/удалении/дублировании доски.
- Изменении количества объектов на доске (если это реализовано триггером или в коде).

### Логика выбора досок:
1. **Приоритет блокировки "Тяжелых" досок**:
   - Если количество объектов на доске (`object_count`) превышает лимит тарифа (`max_objects`), такая доска считается "Тяжелой".
   - **Все тяжелые доски блокируются (soft_lock)**, независимо от их количества и даты обновления. Они не занимают слоты в лимите `max_boards`.

2. **Заполнение лимита "Нормальными" досками**:
   - Оставшиеся доски (где `object_count <= max_objects`) сортируются по дате обновления (`updated_at DESC`).
   - Первые N досок (где N = `max_boards`) остаются **активными**.
   - Все остальные нормальные доски, не попавшие в топ-N, блокируются (**soft_lock**).

### Пример:
- Тариф: 3 доски, макс. 100 объектов.
- У пользователя 5 досок:
  1. Доска А (150 объектов, вчера) -> **Soft Lock** (превышение объектов).
  2. Доска Б (50 объектов, сегодня) -> **Active** (1-й слот).
  3. Доска В (20 объектов, позавчера) -> **Active** (2-й слот).
  4. Доска Г (10 объектов, месяц назад) -> **Active** (3-й слот).
  5. Доска Д (5 объектов, год назад) -> **Soft Lock** (не хватило слота).

## Ежедневная обработка (`processDailyLocks`)
Запускается по расписанию (cron).
1. Находит доски в `soft_lock` с таймером > 14 дней -> переводит в `hard_lock` (сброс таймера на now).
2. Находит доски в `hard_lock` с таймером > 14 дней -> **УДАЛЯЕТ** доску.

## Техническая реализация
- Сервис: `api/services/boardLockService.js`
- Поля БД:
  - `boards.lock_status` (enum: 'active', 'soft_lock', 'hard_lock')
  - `boards.lock_timer_started_at` (timestamp)
  - `boards.object_count` (int, обновляется при save)
