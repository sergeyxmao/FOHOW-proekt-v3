# Forced Logout Flow (–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥)

> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–µ—Ö–∞–Ω–∏–∑–º—É –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è `session_forced_logout` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä—É—á–Ω–æ–º—É –Ω–∞–∂–∞—Ç–∏—é "–í—ã–π—Ç–∏")
3. –ü–µ—Ä–µ—Ö–æ–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –ø—É–±–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—É—Å—Ç–æ–π —Ö–æ–ª—Å—Ç + –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/App.vue` | –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `handleForcedLogout()`, —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è |
| `api/routes/auth.js` | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `/api/logout` (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ signature –∏–∑ JWT) |

## –§—É–Ω–∫—Ü–∏—è handleForcedLogout()

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/App.vue`

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –ü–æ–ª—É—á–µ–Ω–æ session_forced_logout  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  authStore.isAuthenticated === true? ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ –Ω–µ—Ç
                  ‚ñº
         (–≤—ã—Ö–æ–¥ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏)
                  ‚îÇ –¥–∞
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  currentBoardId && hasUnsavedChanges?‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ –Ω–µ—Ç              ‚îÇ –¥–∞
                  ‚îÇ                  ‚ñº
                  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ   ‚îÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º 5 —Å–µ–∫   ‚îÇ
                  ‚îÇ   ‚îÇ PUT /boards/:id {content: ...} ‚îÇ
                  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ                  ‚îÇ
                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         authStore.logout()          ‚îÇ
‚îÇ    boardStore.clearCurrentBoard()   ‚îÇ
‚îÇ          stopAutoSave()             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      UI –≤ –ø—É–±–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏       ‚îÇ
‚îÇ  (–ø—É—Å—Ç–æ–π —Ö–æ–ª—Å—Ç + –í–æ–π—Ç–∏/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –£—Å–ª–æ–≤–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
- `authStore.isAuthenticated === true`
- `boardStore.currentBoardId !== null`
- `boardStore.hasUnsavedChanges === true`

### –¢–∞–π–º–∞—É—Ç

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: **5 —Å–µ–∫—É–Ω–¥**
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ ‚Äî logout –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ ‚Äî logout –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

## –ö–∞–∫ –≤—ã–∑–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ

–°–æ–±—ã—Ç–∏–µ `session_forced_logout` —è–≤–ª—è–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º window. –î–ª—è –µ–≥–æ –≤—ã–∑–æ–≤–∞:

```javascript
// –ü—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤
window.dispatchEvent(new Event('session_forced_logout'))

// –° –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
window.dispatchEvent(new CustomEvent('session_forced_logout', {
  detail: { reason: 'session_expired' }
}))
```

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. **–ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏** ‚Äî –∫–æ–≥–¥–∞ backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401/403 –∏–∑-–∑–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
2. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Å–µ—Å—Å–∏–π
3. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ** ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
4. **–ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏** ‚Äî –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ grace-–ø–µ—Ä–∏–æ–¥–∞

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (WebSocket)

```javascript
// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
socket.onmessage = (event) => {
  const data = JSON.parse(event.data)

  if (data.type === 'session_terminated') {
    window.dispatchEvent(new Event('session_forced_logout'))
  }
}
```

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (HTTP Interceptor)

```javascript
// –í axios interceptor
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401 && error.response?.data?.code === 'SESSION_TERMINATED') {
      window.dispatchEvent(new Event('session_forced_logout'))
    }
    return Promise.reject(error)
  }
)
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Backend /api/logout

### –ü—Ä–æ–±–ª–µ–º–∞ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –ø–æ `token_signature` (–ø–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å JWT), –Ω–æ —É–¥–∞–ª—è–ª–∞—Å—å –ø–æ –ø–æ–ª–Ω–æ–º—É `token`:

```javascript
// –ë–´–õ –ë–ê–ì:
await pool.query(
  'DELETE FROM active_sessions WHERE token_signature = $1',
  [token]  // ‚Üê –ø–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω –≤–º–µ—Å—Ç–æ signature
)
```

### –†–µ—à–µ–Ω–∏–µ

```javascript
// –ò–°–ü–†–ê–í–õ–ï–ù–û:
const tokenParts = token.split('.')
const tokenSignature = tokenParts.length === 3 ? tokenParts[2] : token

await pool.query(
  'DELETE FROM active_sessions WHERE token_signature = $1 RETURNING id',
  [tokenSignature]  // ‚Üê —Ç–æ–ª—å–∫–æ signature
)
```

## –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É/—Å—Ç–∏–∫–µ—Ä)
4. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console
5. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: `window.dispatchEvent(new Event('session_forced_logout'))`
6. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   - –í Network: `PUT /boards/:id` (–µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
   - –í Console: –ª–æ–≥–∏ `üîí Forced logout: ...`
   - UI: –ø—É—Å—Ç–æ–π —Ö–æ–ª—Å—Ç + –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏"/"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/stores/auth.js` ‚Äî `logout()` action
- `src/stores/board.js` ‚Äî `clearCurrentBoard()`, `hasUnsavedChanges`
- `src/components/Layout/MobileHeader.vue` ‚Äî —Ä—É—á–Ω–æ–π logout —á–µ—Ä–µ–∑ –º–µ–Ω—é

## –†–∏—Å–∫–∏

1. **–í–æ–∑–º–æ–∂–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 5 —Å–µ–∫** –ø–µ—Ä–µ–¥ logout (–≤—Ä–µ–º—è –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
2. **–ü–æ—Ç–µ—Ä—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
git revert <commit-hash>
```

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **2026-01-21**: –°–æ–∑–¥–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º forced logout —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- **2026-01-21**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ –≤ `/api/logout` (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ signature)
