# Forced Logout Flow (–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥)

> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –º–µ—Ö–∞–Ω–∏–∑–º—É –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è `session_forced_logout` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä—É—á–Ω–æ–º—É –Ω–∞–∂–∞—Ç–∏—é "–í—ã–π—Ç–∏")
3. –ü–µ—Ä–µ—Ö–æ–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –ø—É–±–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø—É—Å—Ç–æ–π —Ö–æ–ª—Å—Ç + –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/App.vue` | `handleForcedLogout()`, `clearAllCanvasData()`, —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è |
| `src/main.js` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∞ fetch |
| `src/utils/apiFetch.js` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ fetch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ forced_logout/session_expired |
| `src/components/Common/SessionExpiredModal.vue` | –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ |
| `api/middleware/auth.js` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏, —Ä–∞–∑–ª–∏—á–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ logout |
| `api/cron/tasks.js` | –ö—Ä–æ–Ω-–∑–∞–¥–∞—á–∞ –∞–≤—Ç–æ–≤—ã—Ö–æ–¥–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π (1 —á–∞—Å) |
| `api/routes/auth.js` | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `/api/logout` (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ signature –∏–∑ JWT) |

## –¢–∏–ø—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏

| –¢–∏–ø | –ü—Ä–∏—á–∏–Ω–∞ | –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é |
|-----|---------|------------------------|
| `forced_logout` | –í—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ | "–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±–Ω–∞—Ä—É–∂–µ–Ω –≤—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞." |
| `session_expired` | –ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 1 —á–∞—Å–∞ | "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í—ã –Ω–µ –ø—Ä–æ—è–≤–ª—è–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 1 —á–∞—Å–∞." |

## –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ SessionExpiredModal

**–§–∞–π–ª:** `src/components/Common/SessionExpiredModal.vue`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∏—á–∏–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç UI (modal overlay)
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–Ω—è—Ç–Ω–æ" (forced_logout) –∏–ª–∏ "–í–æ–π—Ç–∏" (session_expired)

## –§—É–Ω–∫—Ü–∏—è handleForcedLogout()

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/App.vue`

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –ü–æ–ª—É—á–µ–Ω–æ session_forced_logout  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  authStore.isAuthenticated === true? ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ –Ω–µ—Ç
                  ‚ñº
         (–≤—ã—Ö–æ–¥ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏)
                  ‚îÇ –¥–∞
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  currentBoardId && hasUnsavedChanges?‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ –Ω–µ—Ç              ‚îÇ –¥–∞
                  ‚îÇ                  ‚ñº
                  ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ   ‚îÇ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å —Ç–∞–π–º–∞—É—Ç–æ–º 5 —Å–µ–∫   ‚îÇ
                  ‚îÇ   ‚îÇ PUT /boards/:id {content: ...} ‚îÇ
                  ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ                  ‚îÇ
                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         authStore.logout()          ‚îÇ
‚îÇ    boardStore.clearCurrentBoard()   ‚îÇ
‚îÇ          stopAutoSave()             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      UI –≤ –ø—É–±–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏       ‚îÇ
‚îÇ  (–ø—É—Å—Ç–æ–π —Ö–æ–ª—Å—Ç + –í–æ–π—Ç–∏/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –£—Å–ª–æ–≤–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
- `authStore.isAuthenticated === true`
- `boardStore.currentBoardId !== null`
- `boardStore.hasUnsavedChanges === true`

### –¢–∞–π–º–∞—É—Ç

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: **5 —Å–µ–∫—É–Ω–¥**
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ ‚Äî logout –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ ‚Äî logout –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

## –ö–∞–∫ –≤—ã–∑–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ

–°–æ–±—ã—Ç–∏–µ `session_forced_logout` —è–≤–ª—è–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º window. –î–ª—è –µ–≥–æ –≤—ã–∑–æ–≤–∞:

```javascript
// –ü—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤
window.dispatchEvent(new Event('session_forced_logout'))

// –° –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
window.dispatchEvent(new CustomEvent('session_forced_logout', {
  detail: { reason: 'session_expired' }
}))
```

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. **–ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏** ‚Äî –∫–æ–≥–¥–∞ backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401/403 –∏–∑-–∑–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
2. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** ‚Äî –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ —Å–µ—Å—Å–∏–π
3. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ** ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
4. **–ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏** ‚Äî –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ grace-–ø–µ—Ä–∏–æ–¥–∞

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (WebSocket)

```javascript
// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
socket.onmessage = (event) => {
  const data = JSON.parse(event.data)

  if (data.type === 'session_terminated') {
    window.dispatchEvent(new Event('session_forced_logout'))
  }
}
```

### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (HTTP Interceptor)

```javascript
// –í axios interceptor
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401 && error.response?.data?.code === 'SESSION_TERMINATED') {
      window.dispatchEvent(new Event('session_forced_logout'))
    }
    return Promise.reject(error)
  }
)
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ (Backend Middleware)

**–§–∞–π–ª:** `api/middleware/auth.js`

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ middleware:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ `active_sessions`
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏—á–∏–Ω—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏ (forced_logout –∏–ª–∏ session_expired)
3. –û–±–Ω–æ–≤–ª—è–µ—Ç `last_seen` –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π

```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
const sessionResult = await pool.query(
  'SELECT id FROM active_sessions WHERE token_signature = $1',
  [tokenSignature]
)

if (sessionResult.rows.length === 0) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥—Ä—É–≥–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
  const otherSessionsResult = await pool.query(
    'SELECT id FROM active_sessions WHERE user_id = $1 LIMIT 1',
    [decoded.userId]
  )

  const hasOtherSessions = otherSessionsResult.rows.length > 0
  const reason = hasOtherSessions ? 'forced_logout' : 'session_expired'

  return reply.code(401).send({
    error: hasOtherSessions ? '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–≤—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)' : '–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞',
    reason: reason  // ‚Üê –≠—Ç–æ—Ç reason –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ frontend
  })
}
```

### –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã

| –£—Å–ª–æ–≤–∏–µ | –ü—Ä–∏—á–∏–Ω–∞ | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ |
|---------|---------|------------|
| –ï—Å—Ç—å –¥—Ä—É–≥–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ | `forced_logout` | –í—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤—ã—Ç–µ—Å–Ω–∏–ª —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é |
| –ù–µ—Ç –¥—Ä—É–≥–∏—Ö —Å–µ—Å—Å–∏–π | `session_expired` | –°–µ—Å—Å–∏—è —É–¥–∞–ª–µ–Ω–∞ –∫—Ä–æ–Ω–æ–º –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |

## –ê–≤—Ç–æ–≤—ã—Ö–æ–¥ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (Backend Cron)

**–§–∞–π–ª:** `api/cron/tasks.js`

–ö—Ä–æ–Ω-–∑–∞–¥–∞—á–∞ `cleanupInactiveSessions()` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Å–µ—Å—Å–∏–∏, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –±–æ–ª–µ–µ 1 —á–∞—Å–∞:

```javascript
cron.schedule('*/5 * * * *', () => {
  cleanupInactiveSessions()
})

async function cleanupInactiveSessions() {
  const result = await pool.query(`
    DELETE FROM active_sessions
    WHERE last_seen < NOW() - INTERVAL '1 hour'
    RETURNING user_id
  `)
  console.log(`[CRON] –£–¥–∞–ª–µ–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π: ${result.rowCount}`)
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_seen

–ü–æ–ª–µ `last_seen` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–º API-–∑–∞–ø—Ä–æ—Å–µ –≤ middleware:

```javascript
await pool.query(
  'UPDATE active_sessions SET last_seen = NOW() WHERE token_signature = $1',
  [tokenSignature]
)
```

## –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ Fetch (Frontend)

**–§–∞–π–ª:** `src/utils/apiFetch.js`

–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π `window.fetch` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ 401 —Å `reason: 'forced_logout'` –∏–ª–∏ `'session_expired'`:

```javascript
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ main.js
import { initFetchInterceptor } from './utils/apiFetch'
initFetchInterceptor()

// –í–Ω—É—Ç—Ä–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∞:
if (response.status === 401) {
  const data = await response.clone().json()
  const isSessionTerminated = ['forced_logout', 'session_expired'].includes(data.reason)

  if (isSessionTerminated) {
    window.dispatchEvent(new CustomEvent('session_forced_logout', {
      detail: {
        reason: data.reason,  // 'forced_logout' –∏–ª–∏ 'session_expired'
        message: data.error
      }
    }))
  }
}
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–ª–∞–≥ `isForcedLogoutInProgress` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

## –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞ (Frontend)

**–§–∞–π–ª:** `src/App.vue`

–§—É–Ω–∫—Ü–∏—è `clearAllCanvasData()` –æ—á–∏—â–∞–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ —Ö–æ–ª—Å—Ç–∞ –ø—Ä–∏ logout:

```javascript
function clearAllCanvasData() {
  cardsStore.cards = []
  cardsStore.selectedCardIds = []
  connectionsStore.connections = []
  connectionsStore.userCardConnections = []
  stickersStore.clearStickers()
  imagesStore.clearImages()
  notesStore.notes = []
  historyStore.clearHistory()
}
```

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `handleForcedLogout()` –ü–ï–†–ï–î `authStore.logout()` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á–∏—Å—Ç–æ–≥–æ UI.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Backend /api/logout

### –ü—Ä–æ–±–ª–µ–º–∞ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –ø–æ `token_signature` (–ø–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å JWT), –Ω–æ —É–¥–∞–ª—è–ª–∞—Å—å –ø–æ –ø–æ–ª–Ω–æ–º—É `token`:

```javascript
// –ë–´–õ –ë–ê–ì:
await pool.query(
  'DELETE FROM active_sessions WHERE token_signature = $1',
  [token]  // ‚Üê –ø–æ–ª–Ω—ã–π —Ç–æ–∫–µ–Ω –≤–º–µ—Å—Ç–æ signature
)
```

### –†–µ—à–µ–Ω–∏–µ

```javascript
// –ò–°–ü–†–ê–í–õ–ï–ù–û:
const tokenParts = token.split('.')
const tokenSignature = tokenParts.length === 3 ? tokenParts[2] : token

await pool.query(
  'DELETE FROM active_sessions WHERE token_signature = $1 RETURNING id',
  [tokenSignature]  // ‚Üê —Ç–æ–ª—å–∫–æ signature
)
```

## –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –¢–µ—Å—Ç 1: –†—É—á–Ω–æ–π –≤—ã–∑–æ–≤ —Å–æ–±—ã—Ç–∏—è

1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–¥–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É/—Å—Ç–∏–∫–µ—Ä)
4. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console
5. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: `window.dispatchEvent(new CustomEvent('session_forced_logout', { detail: { reason: 'forced_logout' } }))`
6. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   - –í Network: `PUT /boards/:id` (–µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
   - –í Console: –ª–æ–≥–∏ `üîí Forced logout: ...`
   - **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ** —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º "–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
   - UI: –ø—É—Å—Ç–æ–π —Ö–æ–ª—Å—Ç (–∫–∞—Ä—Ç–æ—á–∫–∏/—Å—Ç–∏–∫–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã) + –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏"/"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"

### –¢–µ—Å—Ç 2: Forced logout –ø—Ä–∏ –≤—Ö–æ–¥–µ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –¢–∞—Ä–∏—Ñ —Å –ª–∏–º–∏—Ç–æ–º —Å–µ—Å—Å–∏–π = 1 (–Ω–∞–ø—Ä–∏–º–µ—Ä, Demo)

1. **–í–∫–ª–∞–¥–∫–∞ A:** –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –¥–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É
2. **–í–∫–ª–∞–¥–∫–∞ B (–∏–Ω–∫–æ–≥–Ω–∏—Ç–æ):** –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –ø–æ–¥ —Ç–µ–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
3. **–í–∫–ª–∞–¥–∫–∞ A:** –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ª—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏)
4. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫–µ A:
   - –í Console: `[ApiFetch] –ü–æ–ª—É—á–µ–Ω forced_logout –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞`
   - **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ**: "–û–±–Ω–∞—Ä—É–∂–µ–Ω –≤—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
   - –•–æ–ª—Å—Ç **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç–æ–π** (–Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫/—Ñ–∏–≥—É—Ä)
   - –ö–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏"/"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"

### –¢–µ—Å—Ç 3: Session expired –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ cron —Å 1 hour –Ω–∞ 1 minute

1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
2. –î–æ–∂–¥–∏—Ç–µ—Å—å —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∫—Ä–æ–Ω–æ–º (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö backend)
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ª—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
4. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   - –í Console: `[ApiFetch] –ü–æ–ª—É—á–µ–Ω session_expired –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞`
   - **–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ**: "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í—ã –Ω–µ –ø—Ä–æ—è–≤–ª—è–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 1 —á–∞—Å–∞."
   - –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏" –≤ –º–æ–¥–∞–ª–µ

### –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ö–æ–ª—Å—Ç–∞

1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏/—Å—Ç–∏–∫–µ—Ä–∞–º–∏/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
2. –í—ã–∑–æ–≤–∏—Ç–µ forced logout (–ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: —Ö–æ–ª—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–º**
   - –ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫
   - –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –ù–µ—Ç —Å—Ç–∏–∫–µ—Ä–æ–≤
   - –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/stores/auth.js` ‚Äî `logout()` action
- `src/stores/board.js` ‚Äî `clearCurrentBoard()`, `hasUnsavedChanges`
- `src/components/Layout/MobileHeader.vue` ‚Äî —Ä—É—á–Ω–æ–π logout —á–µ—Ä–µ–∑ –º–µ–Ω—é

## –†–∏—Å–∫–∏

1. **–í–æ–∑–º–æ–∂–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 5 —Å–µ–∫** –ø–µ—Ä–µ–¥ logout (–≤—Ä–µ–º—è –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
2. **–ü–æ—Ç–µ—Ä—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏ –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
git revert <commit-hash>
```

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **2026-01-21**: –î–æ–±–∞–≤–ª–µ–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ SessionExpiredModal —Å –¥–≤—É–º—è —Ä–µ–∂–∏–º–∞–º–∏
- **2026-01-21**: –î–æ–±–∞–≤–ª–µ–Ω –∫—Ä–æ–Ω –∞–≤—Ç–æ–≤—ã—Ö–æ–¥–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π (1 —á–∞—Å)
- **2026-01-21**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞ –ø—Ä–∏ forced logout
- **2026-01-21**: –†–∞–∑–ª–∏—á–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ logout (forced_logout vs session_expired)
- **2026-01-21**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –≤ middleware auth.js
- **2026-01-21**: –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ fetch –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ forced_logout
- **2026-01-21**: –°–æ–∑–¥–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º forced logout —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- **2026-01-21**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ –≤ `/api/logout` (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ signature)
