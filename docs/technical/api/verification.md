# Verification API

API для верификации партнёров FOHOW через персональную реферальную ссылку.

## Общая информация

- **Базовый префикс:** `/api/verification`
- **Авторизация:** JWT (Bearer Token)
- **Роли:**
  - пользователь
  - администратор (для модерации)

## POST /api/verification/submit

**Описание:** Отправка заявки на верификацию пользователем.

**Тип запроса:** `multipart/form-data`

### Поля запроса

| Поле | Тип | Обязательное | Описание |
| --- | --- | --- | --- |
| `full_name` | string | ✅ | Полное ФИО пользователя |
| `referral_link` | string | ✅ | Персональная реферальная ссылка FOHOW |

### Правила валидации referral_link

- обязательное поле
- должно начинаться с `http://www.fohow`
- должно содержать `id=`
- максимальная длина — 60 символов

**Пример корректной ссылки:**
`http://www.fohow.plus/clientRegProm?id=2891936`

### Пример ответа (200)

```json
{
  "success": true,
  "message": "Заявка на верификацию отправлена"
}
```

### Возможные ошибки

- `400` — ошибка валидации
- `401` — не авторизован
- `409` — заявка уже существует

## GET /api/verification/status

**Описание:** Получить текущий статус верификации пользователя.

### Пример ответа

```json
{
  "status": "pending",
  "hasPendingRequest": true,
  "lastRequestTime": "2025-01-27T08:42:00Z"
}
```

## GET /api/verification/history

**Описание:** История заявок на верификацию пользователя.

### Пример элемента истории

```json
{
  "id": 12,
  "full_name": "Иванов Иван Иванович",
  "referral_link": "http://www.fohow.plus/clientRegProm?id=2891936",
  "status": "approved",
  "submitted_at": "2025-01-25T10:12:00Z",
  "processed_at": "2025-01-26T09:30:00Z"
}
```

## POST /api/verification/cancel

**Описание:** Отмена пользователем активной заявки на верификацию.

## Административные endpoints

Без углубления в детали реализации:

- `GET /api/admin/verifications/pending`
- `POST /api/admin/verifications/:id/approve`
- `POST /api/admin/verifications/:id/reject`
- `GET /api/admin/verifications/archive`

### Примечания для админских запросов

- администратор видит `referral_link`
- скриншоты не используются

## Защита от дублей и автоотклонение

### Проверка верифицированного номера при сохранении

При попытке сохранить номер, уже верифицированный другим пользователем, возвращается ошибка `409`:

```json
{
  "error": "Этот номер уже верифицирован другим пользователем. Если вы считаете, что это ваш номер, обратитесь в поддержку.",
  "errorType": "VERIFIED_BY_OTHER",
  "supportTelegram": "https://t.me/FOHOWadmin",
  "supportEmail": "marketingfohow@yandex.com"
}
```

### pending_personal_id

При подаче заявки на верификацию текущий `personal_id` пользователя сохраняется в поле `pending_personal_id` таблицы `user_verifications`. Это гарантирует, что админ видит именно тот номер, который был у пользователя в момент подачи заявки.

### Автоотклонение дублей

При одобрении заявки на верификацию все другие pending-заявки с тем же `pending_personal_id` автоматически отклоняются с причиной "Номер уже верифицирован другим пользователем".

Уведомления:
- **Telegram:** сообщение с кнопками "Написать в поддержку" и "В профиль"
- **Email:** письмо с контактами поддержки

## Уведомления при обработке заявок

### При одобрении (approveVerification)

Пользователь получает уведомления:
- **Telegram:** сообщение с подтверждением верификации и кнопкой перехода в профиль
- **Email:** HTML-письмо с информацией об успешной верификации (шаблон `getVerificationApprovedTemplate`)

### При отклонении (rejectVerification)

Пользователь получает уведомления:
- **Telegram:** сообщение с причиной отклонения и информацией о возможности повторной подачи через 24 часа
- **Email:** HTML-письмо с причиной отклонения и контактами поддержки (шаблон `getVerificationRejectedTemplate`)

## Формат времени и Cooldown

### Формат времени

Все временные метки в API возвращаются в формате **ISO 8601 UTC**:

```
YYYY-MM-DDTHH:MM:SSZ
```

Пример: `2025-01-27T08:42:00Z`

Суффикс `Z` указывает на UTC (Coordinated Universal Time).

### Cooldown (период ожидания)

После подачи заявки на верификацию пользователь должен ждать **24 часа** перед повторной подачей.

**Важно:** Расчёт cooldown выполняется полностью на стороне PostgreSQL с использованием `AT TIME ZONE 'UTC'` для гарантии корректной работы независимо от timezone сервера приложения.

Пример ответа с активным cooldown:

```json
{
  "isVerified": false,
  "hasPendingRequest": false,
  "cooldownUntil": "2025-01-28T08:42:00Z",
  "lastRejection": {
    "rejection_reason": "Некорректная реферальная ссылка",
    "processed_at": "2025-01-27T08:42:00Z"
  }
}
```

Клиент должен интерпретировать `cooldownUntil` как UTC timestamp и конвертировать в локальное время пользователя для отображения.
