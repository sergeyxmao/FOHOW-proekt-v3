# MyLibraryTab.vue

## Описание

Компонент для управления личной библиотекой изображений пользователя. Позволяет просматривать, загружать, удалять, переименовывать изображения, а также организовывать их по папкам.

**Путь**: `src/components/Images/MyLibraryTab.vue`

## Props

| Название | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `placementTarget` | String | `'board'` | Цель размещения изображения ('board' или другое) |

## Основные возможности

### 1. Управление папками
- Просмотр списка папок
- Создание новых папок
- Фильтрация изображений по папкам

### 2. Загрузка изображений
- Множественная загрузка файлов
- Автоматическая конвертация в WebP
- Валидация типов файлов
- Обработка лимитов хранилища

### 3. Управление изображениями
- Добавление на доску
- Удаление изображений
- Переименование
- Запрос на публикацию в общую библиотеку

### 4. Пагинация и поиск
- Infinite scroll для загрузки следующих страниц
- Локальный поиск по имени файла
- Limit: 40 изображений на страницу

## Используемые stores

```javascript
import { useStickersStore } from '../../stores/stickers'
import { useBoardStore } from '../../stores/board'
import { useNotificationsStore } from '../../stores/notifications'
```

## Используемые сервисы

```javascript
import {
  getMyFolders,      // Получение списка папок
  getMyImages,       // Получение изображений с пагинацией
  uploadImage,       // Загрузка изображения
  deleteImage,       // Удаление изображения
  requestShareImage, // Запрос на публикацию
  renameImage,       // Переименование
  createFolder       // Создание папки
} from '../../services/imageService'
```

## Основные методы

### loadFolders()
Загружает список папок пользователя.

### loadInitialImages()
Загружает первую страницу изображений для выбранной папки.

### loadMoreImages()
Дозагружает следующую страницу изображений (infinite scroll).

### uploadSingleImage(file)
Загружает одно изображение:

1. Валидация типа файла (`isImageFile()`)
2. Конвертация в WebP с оптимизацией (`convertToWebP()`)
3. Загрузка на сервер через `uploadImage()`
4. Добавление в локальный список `images.value`
5. Обновление счетчика `pagination.value.total`
6. Отображение уведомления об успехе

**Важно**: После успешной загрузки отображается одно уведомление об успехе. Ранее существовала попытка вызова несуществующей функции `loadStats()`, которая была удалена.

### handleImageClick(image)
Активирует режим размещения изображения на доске:
- Проверяет наличие `boardId`
- Включает placement mode через `stickersStore.enablePlacementMode()`
- Сохраняет данные изображения в `stickersStore.pendingImageData`

### handleImageDelete(image)
Удаляет изображение:
- Запрашивает подтверждение
- Вызывает `deleteImage(imageId)`
- Удаляет из локального списка
- Обрабатывает ошибку `IMAGE_IN_USE` (изображение используется на досках)

### handleRename(image)
Переименовывает изображение через prompt.

### handleShareRequest(image)
Отправляет запрос на добавление изображения в общую библиотеку.

### handleCreateFolder()
Открывает модальное окно для создания новой папки.

## Обработка ошибок

Компонент обрабатывает специфические коды ошибок:

- `IMAGE_LIBRARY_ACCESS_DENIED` - отображает UI недоступности библиотеки
- `FILE_SIZE_LIMIT_EXCEEDED` - превышен лимит размера файла
- `IMAGE_COUNT_LIMIT_EXCEEDED` - превышен лимит количества изображений
- `STORAGE_LIMIT_EXCEEDED` - превышен лимит хранилища
- `IMAGE_IN_USE` - изображение используется на досках
- `RATE_LIMIT_EXCEEDED` - превышен лимит запросов

## Исправленные проблемы

### Проблема с loadStats() (2026-01-10)

**Симптомы**:
- После успешной загрузки изображения появлялось 2 toast-сообщения
- В консоли ReferenceError: `loadStats is not defined`
- Upload проходил успешно, но приложение падало после

**Причина**:
В функции `uploadSingleImage()` (строка ~358) был вызов несуществующей функции `await loadStats()`.

**Решение**:
Удалена строка вызова `await loadStats()`. Статистика библиотеки управляется через composable `useUserLimits` (см. `src/composables/useUserLimits.js`), который можно использовать в других компонентах, где необходимо отображение лимитов.

**Примечание**: Если в будущем потребуется обновлять статистику после загрузки, можно использовать:

```javascript
import { getMyStats } from '@/services/imageService'

// После успешной загрузки
try {
  await getMyStats() // Получить свежую статистику
  // Можно emit событие или обновить глобальное состояние
} catch (error) {
  console.error('Не удалось обновить статистику:', error)
  // Graceful degradation - не показываем ошибку пользователю
}
```

## Связанные файлы

- `src/services/imageService.js` - API сервис для работы с изображениями
- `src/utils/imageUtils.js` - Утилиты для работы с изображениями (конвертация, валидация)
- `src/composables/useUserLimits.js` - Composable для работы со статистикой и лимитами
- `src/components/Images/ImageCard.vue` - Карточка изображения
- `src/stores/stickers.js` - Store для управления стикерами и размещением

## Тестирование

**Тест успешной загрузки**:
1. Открыть MyLibraryTab
2. Нажать "Загрузить"
3. Выбрать изображение(я)
4. Проверить:
   - ✅ Одно уведомление об успехе
   - ✅ Нет ошибок в консоли
   - ✅ Изображение появилось в списке
   - ✅ Счетчик total обновился

**Откат изменений**:
```bash
git checkout HEAD -- src/components/Images/MyLibraryTab.vue
```

## Потенциальные улучшения

1. **Drag & Drop** для загрузки файлов
2. **Batch операции** (множественное удаление, перемещение)
3. **Предпросмотр** изображения перед загрузкой
4. **Прогресс-бар** для загрузки больших файлов
5. **Сортировка** (по дате, размеру, имени)
