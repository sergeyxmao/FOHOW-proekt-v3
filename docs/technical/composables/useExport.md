# Экспорт PNG - useProjectActions.js

## Обзор

Функция `handleExportPNG` из composable `useProjectActions.js` отвечает за экспорт схемы (board) в формат PNG с различными настройками.

## Основные возможности

### 1. Форматы экспорта

- **Оригинальный размер** - экспортирует в исходном разрешении (2x от видимой области)
- **A4, A3, A2, A1** - стандартные форматы листов с настраиваемой ориентацией

### 2. Ориентация

- **Книжная (Portrait)** - вертикальная ориентация
- **Альбомная (Landscape)** - горизонтальная ориентация

### 3. Разрешение (DPI)

- **96 DPI** - для веб (низкое качество)
- **150 DPI** - стандартное качество
- **300 DPI** - для печати (рекомендуется)
- **600 DPI** - высокое качество (для профессиональной печати)

### 4. Режимы экспорта

- **Экспорт только видимой области** - экспортирует только то, что видно в viewport
- **Экспорт всей схемы** - экспортирует все элементы на доске (карточки, изображения, стикеры, якоря, соединения)

## Дополнительные опции

### Опция "Скрыть содержимое" (`hideContent`)

**Назначение:** Скрывает конфиденциальные данные при экспорте, оставляя только структуру карточек.

**Что СКРЫВАЕТСЯ:**
- Заголовки карточек (`.card-title`)
- Значения полей (`.value`) - балансы, актив-заказы, циклы/этапы
- PV (монетка и значения) (`.pv-row`, `.coin-icon-wrapper`, `.pv-value-container`)
- HTML-содержимое карточек (`.card-body-html`)
- Аватары в карточках (`.card-avatar-container`, `.card-avatar`)
- Отдельные аватары (`.avatar-object`)
- Изображения на канвасе (`.canvas-image`)

**Что ОСТАЕТСЯ ВИДИМЫМ:**
- Подписи полей (`.label`): "Баланс:", "Актив-заказы:", "Цикл/этап:"
- Структура карточек (рамка, фон)
- Соединения между карточками

**Пример результата:**
```
┌─────────────────────┐
│                     │
├─────────────────────┤
│ Баланс:             │
│ Актив-заказы:       │
│ Цикл/этап:          │
└─────────────────────┘
```

### Опция "Ч/Б (контур)" (`blackAndWhite`)

**Назначение:** Преобразует всю схему в чёрно-белый формат для печати или презентаций.

**Применяемые изменения:**

#### 1. Карточки (включая Gold-лицензии)
- **Фон:** белый (#ffffff)
- **Рамка:** чёрная 2px solid (#000000)
- **Тени:** удаляются
- **Фильтр:** `grayscale(100%)` - применяется ко ВСЕЙ карточке и всем её дочерним элементам

#### 2. Заголовки карточек
- **Фон:** белый (#ffffff)
- **Текст:** чёрный (#000000)
- **Градиенты:** удаляются

#### 3. Тело карточки
- **Фон:** белый (#ffffff)
- **Градиенты:** удаляются (важно для Gold-карточек)

#### 4. Цветные элементы
- **Скрываются:** монетки (`.coin-icon`), значки SLF, Fendou, ранговые значки

#### 5. Аватары
- **Контейнеры аватаров в карточках** (`.card-avatar-container`): `grayscale(100%)`
- **Аватары в карточках** (`.card-avatar`): `grayscale(100%)`
- **Отдельные аватары** (`.avatar-object`, `.avatar-circle`): `grayscale(100%)`
- **Изображения аватаров** (`.avatar-circle img`): `grayscale(100%)`

#### 6. Изображения на канвасе
- **Все изображения** (`.canvas-image`, `.canvas-image img`): `grayscale(100%)`

**Критические особенности:**
- Фильтр `grayscale(100%)` применяется на уровне `.card`, что автоматически применяет его ко ВСЕМ дочерним элементам
- Gold-карточки теряют золотой цвет и становятся Ч/Б
- Аватарки (как в карточках, так и отдельные) становятся Ч/Б
- ВСЕ элементы схемы становятся Ч/Б без исключений

## Технические детали

### Обработка изображений

**Проблема:** html2canvas не может загружать изображения с внешних URL из-за CORS ограничений.

**Решение:** Все изображения конвертируются в data URI **ДО** экспорта:
```javascript
await inlineImages(canvasContainer)
```

### Обработка аватаров в карточках

**Проблема:** Аватары в Card.vue используют `background-image` с `border-radius`, что html2canvas может некорректно обрабатывать.

**Решение:** В функции `onclone` добавлена специальная обработка:
```javascript
const cardAvatarContainers = clonedElement.querySelectorAll('.card-avatar-container')
cardAvatarContainers.forEach(container => {
  container.style.visibility = 'visible'
  container.style.opacity = '1'
})

const cardAvatars = clonedElement.querySelectorAll('.card-avatar')
cardAvatars.forEach(avatar => {
  avatar.style.visibility = 'visible'
  avatar.style.opacity = '1'
  // Убедимся что background-image корректно обрабатывается
  const computedStyle = clonedDoc.defaultView.getComputedStyle(avatar)
  if (computedStyle.backgroundImage && computedStyle.backgroundImage !== 'none') {
    avatar.style.backgroundSize = 'cover'
    avatar.style.backgroundPosition = 'center'
    avatar.style.backgroundRepeat = 'no-repeat'
  }
})
```

Эта обработка применяется в **ОБОИХ** режимах экспорта:
- Экспорт только видимой области (строки 1517-1536)
- Экспорт всей схемы (строки 1918-1939)

### Обработка SVG-слоя

SVG-слой (соединения) требует специальной настройки размеров перед экспортом:
```javascript
if (svgLayer) {
  svgLayer.setAttribute('width', contentWidth)
  svgLayer.setAttribute('height', contentHeight)
  svgLayer.style.width = `${contentWidth}px`
  svgLayer.style.height = `${contentHeight}px`
}
```

### html2canvas настройки

```javascript
await html2canvas(canvasContainer, {
  backgroundColor: '#ffffff', // Фон ВСЕГДА белый
  logging: false,
  useCORS: true,
  scale: scale, // зависит от DPI
  width: contentWidth,
  height: contentHeight,
  windowWidth: contentWidth,
  windowHeight: contentHeight,
  x: 0,
  y: 0,
  scrollX: 0,
  scrollY: 0,
  foreignObjectRendering: true, // КРИТИЧНО для SVG
  onclone: (clonedDoc, clonedElement) => {
    // Специальная обработка элементов в клоне
  }
})
```

**Важно:**
- `backgroundColor` - всегда `'#ffffff'` (белый), независимо от настроек доски
- `foreignObjectRendering: true` - необходим для корректного рендеринга SVG
- `onclone` - используется для финальных корректировок элементов перед захватом

## Типы карточек

### Обычная карточка
- Стандартный размер
- Без аватара

### Большая карточка (`card.type === 'large'` или `card.width >= 543.4`)
- Увеличенный размер
- Отображается аватар пользователя

### Gold карточка (`card.type === 'gold'`)
- Золотой фон/градиент
- Отображается аватар пользователя
- При экспорте с опцией "Ч/Б" теряет золотой цвет

## Восстановление стилей

После экспорта все временные стили восстанавливаются:
```javascript
tempStyles.forEach(({ element, property, originalValue }) => {
  if (originalValue) {
    element.style[property] = originalValue
  } else {
    element.style[property] = ''
  }
})
```

Также восстанавливаются оригинальные src изображений (которые были заменены на data URI).

## Формат имени файла

```
{boardName} {ДД.ММ}_{ЧЧ.МИН}.png
```

Пример:
```
Моя доска 13.02_14.30.png
```

- Имя берётся из `boardStore.currentBoardName`
- Недопустимые символы для файлов (`<>:"/\|?*`) заменяются на `_`

## Применяемые при экспорте стили

### Фон — всегда белый
Независимо от настроенного пользователем фона доски, PNG экспорт всегда использует белый фон (`#ffffff`).

### Аватар-круг скрывается
Контейнер аватара (`.card-avatar-container`) скрывается (`display: none`) при любом экспорте, чтобы пустой круг не появлялся на экспортированном изображении.

### Увеличенный и жирный текст
При экспорте все текстовые элементы карточек увеличиваются:
- `.label` (подписи): `font-size: 20px`, `font-weight: 700`
- `.value` (значения): `font-size: 22px`, `font-weight: 700`
- `.card-title` (заголовки): `font-size: 26px`, `font-weight: 900`

## Исправленные проблемы

### 1. Аватарки не экспортировались для Большой и Gold лицензий
**Причина:** Аватары в Card.vue не обрабатывались в `onclone`.
**Исправление:** Добавлена специальная обработка `.card-avatar-container` и `.card-avatar` в обоих режимах экспорта.

### 2. "Скрыть содержимое" скрывало лишние элементы
**Причина:** Скрывались все элементы, включая подписи полей (`.label`).
**Исправление:** Изменена логика - теперь скрываются только значения (`.value`), но подписи (`.label`) остаются видимыми.

### 3. "Ч/Б (контур)" не работало для Gold и аватарок
**Причина:**
- Gold карточки имели градиенты, которые не перезаписывались
- Фильтр grayscale не применялся к `.card-avatar-container`
**Исправление:**
- Добавлено принудительное удаление градиентов из `.card-body`
- Добавлен `grayscale(100%)` фильтр на `.card`, который применяется ко ВСЕМ дочерним элементам
- Добавлен фильтр к `.card-avatar-container` и всем типам аватаров

## Ограничения

1. html2canvas не поддерживает все CSS свойства (например, некоторые backdrop-filter)
2. Анимации не экспортируются (экспортируется только текущее состояние)
3. Некоторые шрифты могут отображаться некорректно если не загружены
4. Размер файла может быть большим при высоких DPI

## Рекомендации

1. **Для печати:** используйте 300 DPI или выше
2. **Для веб:** используйте 96-150 DPI
3. **Для конфиденциальных схем:** используйте опцию "Скрыть содержимое"
4. **Для печати на Ч/Б принтере:** используйте опцию "Ч/Б (контур)"
5. **Для больших схем:** используйте "Экспорт всей схемы" вместо "Экспорт видимой области"

## См. также

- `src/composables/useProjectActions.js` - реализация экспорта
- `src/components/ExportSettingsModal.vue` - UI для настроек экспорта
- [docs/technical/png-export.md](../png-export.md) - документация UI модального окна "Сохранить как картинку"
- `src/components/Canvas/Card.vue` - компонент карточки
- `src/utils/imageUtils.js` - утилиты для работы с изображениями
