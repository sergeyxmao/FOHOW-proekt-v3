# Система компьютерных номеров (personal_id)

## Общее описание

Компьютерный номер (`personal_id`) — уникальный идентификатор партнёра в системе FOHOW. Присваивается автоматически при первой верификации email или задаётся вручную пользователем в профиле.

## Формат номера

```
[Представительство (office)][9 цифр]
```

- **Представительство (office)**: 3 заглавные буквы + 2-3 цифры (5-6 символов)
- **Порядковый номер**: 9 цифр с ведущими нулями
- **Итого**: 14-15 символов

### Примеры

| Office  | personal_id       | Длина |
|---------|-------------------|-------|
| RUY000  | RUY000000000028   | 15    |
| RUY68   | RUY68000000001    | 14    |
| RU182   | RU182000000005    | 14    |

## Автогенерация

При первой верификации email (эндпоинт `POST /api/verify-email`) система:

1. Проверяет, есть ли у пользователя `personal_id` — если уже задан, не перезаписывает
2. Вызывает `generateUniquePersonalId(client, office)` из `api/routes/auth.js`
3. Использует `office` пользователя как префикс. Если `office` не задан — используется `RUY000`
4. Получает следующий порядковый номер из таблицы `personal_id_counter` (с блокировкой `FOR UPDATE`)
5. Формирует номер: `{prefix}${padStart(number, 9, '0')}`
6. Проверяет уникальность в таблице `users`
7. При активации также устанавливает `office = 'RUY000'` (через `COALESCE`), если оно не было задано ранее

## Валидация

### Валидация office

```javascript
// api/routes/auth.js — функция validateOffice()
const pattern = /^[A-Z]{3}\d{2,3}$/;
```

Формат: 3 заглавные латинские буквы + 2-3 цифры.

### Валидация personal_id

```javascript
// api/routes/auth.js — функция validatePersonalId(personalId, office)
```

Проверяет, что `personal_id` начинается с `office` (нормализованного) и содержит ровно 9 цифр после него.

### Regex-эквивалент

```
/^[A-Z]{3}\d{2,3}\d{9}$/
```

## Расположение в коде

| Файл | Описание |
|------|----------|
| `api/routes/auth.js` | `generateUniquePersonalId()` — автогенерация при регистрации |
| `api/routes/auth.js` | `validateOffice()`, `validatePersonalId()` — валидация |
| `api/routes/auth.js` | `POST /api/verify-email` — эндпоинт активации аккаунта |
| `api/routes/profile.js` | `PUT /api/profile` — обновление профиля с валидацией personal_id |
| `src/composables/useUserPersonalInfo.js` | UI-логика парсинга и отображения personal_id |

## Таблица personal_id_counter

| Поле | Тип | Описание |
|------|-----|----------|
| id | integer (PK) | Всегда = 1 (единственная запись) |
| last_issued_number | integer | Последний выданный порядковый номер |
| updated_at | timestamp | Время последнего обновления |

## История изменений

- **2026-02-09** — Исправлен префикс автогенерации: `RUY00` (5 символов) → `RUY000` (6 символов). При активации аккаунта также устанавливается `office = 'RUY000'`.
