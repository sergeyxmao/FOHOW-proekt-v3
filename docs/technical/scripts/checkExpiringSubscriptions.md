# checkExpiringSubscriptions.js ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

## –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

`api/scripts/checkExpiringSubscriptions.js`

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ —Å–∫–æ—Ä–æ–º –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ Telegram.

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –£—Å–ª–æ–≤–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–°–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑:
- **7 –¥–Ω–µ–π** ‚Äî –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- **3 –¥–Ω—è** ‚Äî –≤—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (—Å—Ä–æ—á–Ω–æ–µ)
- **1 –¥–µ–Ω—å** ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```sql
WHERE 
  u.telegram_chat_id IS NOT NULL  -- –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω Telegram
  AND u.subscription_expires_at IS NOT NULL  -- –ï—Å—Ç—å –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è
  AND u.subscription_expires_at > NOW()  -- –ü–æ–¥–ø–∏—Å–∫–∞ –µ—â—ë –∞–∫—Ç–∏–≤–Ω–∞
  AND sp.code_name != 'guest'  -- –ù–µ –≥–æ—Å—Ç–µ–≤–æ–π —Ç–∞—Ä–∏—Ñ
  AND CEIL(EXTRACT(EPOCH FROM (u.subscription_expires_at - NOW())) / 86400) IN (7, 3, 1)
–†–∞—Å—á—ë—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏:

javascript
CEIL(EXTRACT(EPOCH FROM (subscription_expires_at - NOW())) / 86400)
–ü—Ä–∏–º–µ—Ä:

–û—Å—Ç–∞–ª–æ—Å—å 2 –¥–Ω—è 23 —á–∞—Å–∞ ‚Üí 3 –¥–Ω—è (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö)

–û—Å—Ç–∞–ª–æ—Å—å 0 –¥–Ω–µ–π 5 —á–∞—Å–æ–≤ ‚Üí 1 –¥–µ–Ω—å (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö)

–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
Cron-–∑–∞–¥–∞—á–∞
–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00 —á–µ—Ä–µ–∑ cron:

bash
0 10 * * * cd /var/www/FOHOW-proekt-v3/api && /usr/bin/node scripts/checkExpiringSubscriptions.js >> /var/log/fohow-subscriptions.log 2>&1
–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
bash
crontab -l
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
bash
crontab -e
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–§–∞–π–ª –ª–æ–≥–æ–≤
/var/log/fohow-subscriptions.log

–§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤
text
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫... 2026-01-15T10:00:00.000Z
üìã –ù–∞–π–¥–µ–Ω–æ –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: 3

üë§ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤ (ivan@example.com)
   –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: 7
   –ü–ª–∞–Ω: Premium
   ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

üë§ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞ (maria@example.com)
   –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: 3
   –ü–ª–∞–Ω: Individual
   ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫
tail -n 50 /var/log/fohow-subscriptions.log

# –í —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f /var/log/fohow-subscriptions.log

# –ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ
grep "2026-01-15" /var/log/fohow-subscriptions.log
–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
bash
# –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥ (–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª)
> /var/log/fohow-subscriptions.log

# –£–¥–∞–ª–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ
rm /var/log/fohow-subscriptions.log
touch /var/log/fohow-subscriptions.log
chmod 644 /var/log/fohow-subscriptions.log
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
bash
cd /var/www/FOHOW-proekt-v3/api
node scripts/checkExpiringSubscriptions.js
–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
sql
-- –ò—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è
UPDATE users 
SET subscription_expires_at = NOW() + INTERVAL '3 days',
    plan_id = 7  -- Premium
WHERE id = YOUR_USER_ID;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT 
  id, 
  full_name, 
  subscription_expires_at,
  CEIL(EXTRACT(EPOCH FROM (subscription_expires_at - NOW())) / 86400) as days_left
FROM users 
WHERE id = YOUR_USER_ID;
–°–±—Ä–æ—Å –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫
sql
UPDATE users 
SET subscription_expires_at = NOW() + INTERVAL '30 days'
WHERE id = YOUR_USER_ID;
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
–ò–º–ø–æ—Ä—Ç—ã
javascript
import { pool } from '../db.js';
import { sendTelegramMessage } from '../utils/telegramService.js';
import { getSubscriptionExpiringMessage } from '../templates/telegramTemplates.js';
–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
text
TELEGRAM_BOT_TOKEN=your_bot_token
FRONTEND_URL=https://interactive.marketingfohow.ru
–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
api/utils/telegramService.js ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ Telegram-—Å–æ–æ–±—â–µ–Ω–∏–π

api/templates/telegramTemplates.js ‚Äî —à–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

api/db.js ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ï—Å–ª–∏ –Ω–µ —É–¥–∞—ë—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å

‚úÖ –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è

javascript
try {
  await sendTelegramMessage(user.telegram_chat_id, message.text, options);
  console.log(`   ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ`);
} catch (error) {
  console.error(`   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`);
}
–£—Ä–æ–≤–µ–Ω—å —Å–∫—Ä–∏–ø—Ç–∞
–ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –æ—à–∏–±–∫–∞ SQL):

‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è

‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ finally

‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞ 0

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
–ü—Ä–æ–≤–µ—Ä—å:

Cron —Ä–∞–±–æ—Ç–∞–µ—Ç:

bash
systemctl status cron
–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:

bash
tail -n 20 /var/log/fohow-subscriptions.log
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç telegram_chat_id:

sql
SELECT id, email, telegram_chat_id FROM users WHERE id = USER_ID;
–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ cron:

bash
# –í crontab –¥–æ–±–∞–≤—å –ø–µ—Ä–µ–¥ –∑–∞–¥–∞—á–µ–π:
TELEGRAM_BOT_TOKEN=your_token
FRONTEND_URL=https://interactive.marketingfohow.ru
–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
–°–∫—Ä–∏–ø—Ç –ù–ï —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ï—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ.

–†–µ—à–µ–Ω–∏–µ:

–ó–∞–ø—É—Å–∫–∞—Ç—å 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å —á–µ—Ä–µ–∑ cron

–ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É notification_history –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

–ù–µ—Ç–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –¥–Ω–µ–π
–ï—Å–ª–∏ –≤–∏–¥–∏—à—å days_left = 2, –Ω–æ –æ–∂–∏–¥–∞–ª 3:

–ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ë–î: SELECT NOW();

–ü—Ä–æ–≤–µ—Ä—å subscription_expires_at –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
bash
# –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∞
ls -lh /var/log/fohow-subscriptions.log

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
tail -n 10 /var/log/fohow-subscriptions.log
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
bash
grep "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" /var/log/fohow-subscriptions.log | wc -l
–û—à–∏–±–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
bash
grep "‚ùå" /var/log/fohow-subscriptions.log | tail -n 20
–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
–ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–î–ª—è >1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:

–ë–∞—Ç—á–∏–Ω–≥ (–ø–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞):

javascript
for (let i = 0; i < users.length; i += 50) {
  const batch = users.slice(i, i + 50);
  await Promise.all(batch.map(user => sendNotification(user)));
  await sleep(1000); // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏
}
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram API:

–ú–∞–∫—Å–∏–º—É–º 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫—É–Ω–¥—É

–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏

–û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏:

sql
CREATE TABLE notification_history (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  notification_type VARCHAR(50),
  sent_at TIMESTAMP DEFAULT NOW()
);
–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
2026-01-15: –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞ 7, 3, 1 –¥–µ–Ω—å

2026-01-15: –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –¥–Ω–µ–π

2026-01-15: –ù–∞—Å—Ç—Ä–æ–µ–Ω cron-–∑–∞–ø—É—Å–∫ –≤ 10:00 –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
