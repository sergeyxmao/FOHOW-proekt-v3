# Правила перехода между тарифами

## Обзор

Система управляет переходами между тарифными планами с учётом иерархии, анти-стакинга и отложенной активации при понижении тарифа.

## Иерархия тарифов

```
guest (0) → demo (1) → individual (2) → premium (3)
бесплатно    7 дней      299 ₽/мес        499 ₽/мес
```

## Матрица переходов

| Текущий тариф | Целевой тариф | Осталось дней | Результат |
|---------------|---------------|---------------|-----------|
| Guest/Demo | Individual/Premium | любое | Немедленная активация |
| Individual | Individual | >30 | **ЗАБЛОКИРОВАНО** (рано для продления) |
| Individual | Individual | ≤30 | Продление (+30 дней от текущего окончания) |
| Individual | Premium | любое | Немедленный апгрейд (без ограничений) |
| Premium | Premium | >30 | **ЗАБЛОКИРОВАНО** (рано для продления) |
| Premium | Premium | ≤30 | Продление (+30 дней от текущего окончания) |
| Premium | Individual | >30 | **ЗАБЛОКИРОВАНО** (рано для понижения) |
| Premium | Individual | ≤30 | **Запланирован** (активируется после окончания Premium) |

## Бизнес-правила

### 1. Продление того же тарифа
- Доступно только за **30 дней** до окончания подписки
- Продлевает от текущей даты окончания + 30 дней

### 2. Апгрейд (Individual → Premium)
- **Стек подписок:** Premium активируется на 30 дней, затем Individual возобновляется
- Тариф меняется немедленно на Premium (NOW → NOW+30)
- Оставшиеся дни Individual сохраняются: `scheduled_plan_id` + `scheduled_plan_expires_at`
- После окончания Premium автоматически активируется Individual до `scheduled_plan_expires_at`
- **Разрешён в любое время**, без ограничений по анти-стакингу
- **Пример:** Individual (50д осталось, до 4 апр) → Premium → Premium до 15 мар, затем Individual 15 мар - 4 апр
- **Честно для разработчика:** платишь 499₽ за 30 дней Premium, получаешь 30 дней Premium

### 3. Даунгрейд (Premium → Individual)
- Доступен только за **30 дней** до окончания подписки
- **Отложенная активация:** Premium продолжает действовать до конца
- После окончания Premium автоматически активируется Individual на 30 дней
- Grace period НЕ начисляется при наличии запланированного тарифа

### 4. Анти-стакинг
- Применяется **только к продлению того же тарифа**
- Нельзя продлить подписку, если итоговый срок превысит **60 дней** от текущей даты
- Предотвращает накопление подписки на много месяцев вперёд
- **НЕ применяется к апгрейдам** — переход на более дорогой тариф разрешён всегда

### 5. Запланированный тариф
- Блокирует любые другие покупки до активации
- Активируется автоматически крон-задачей при истечении текущей подписки
- Информация отображается в профиле пользователя с указанием периода действия
- При **продлении** текущего плана с запланированным — запланированный сдвигается на +30 дней

### 6. Grace Period
- Сохраняется как есть: 7 дней после окончания платного тарифа
- НЕ применяется если есть запланированный тариф

## База данных

### Новые колонки в таблице `users`

```sql
-- Миграция 028
ALTER TABLE users ADD COLUMN scheduled_plan_id INTEGER
  REFERENCES subscription_plans(id) ON DELETE SET NULL;
ALTER TABLE users ADD COLUMN scheduled_plan_paid_at TIMESTAMP;
CREATE INDEX idx_users_scheduled_plan
  ON users(scheduled_plan_id) WHERE scheduled_plan_id IS NOT NULL;

-- Миграция 029
ALTER TABLE users ADD COLUMN scheduled_plan_expires_at TIMESTAMP WITH TIME ZONE;
```

| Колонка | Тип | Описание |
|---------|-----|----------|
| `scheduled_plan_id` | INTEGER FK | ID тарифа, ожидающего активации |
| `scheduled_plan_paid_at` | TIMESTAMP | Дата оплаты запланированного тарифа |
| `scheduled_plan_expires_at` | TIMESTAMP | Дата окончания запланированного тарифа (для стека подписок) |

## API изменения

### POST /api/payments/create-link

Добавлена валидация правил перехода. Новые коды ошибок:

| Код | Описание |
|-----|----------|
| `SCHEDULED_PLAN_EXISTS` | У пользователя уже есть запланированный тариф |
| `RENEWAL_TOO_EARLY` | Продление того же тарифа доступно за 30 дней до окончания (анти-стакинг) |
| `DOWNGRADE_TOO_EARLY` | Понижение доступно за 30 дней до окончания |
| ~~`STACKING_LIMIT`~~ | ~~Более не используется~~ (апгрейды разрешены всегда) |

### GET /api/user/plan

Новое поле в ответе:

```json
{
  "scheduledPlan": {
    "id": 6,
    "name": "Индивидуальный",
    "code_name": "individual",
    "paidAt": "2026-02-12T10:00:00Z"
  }
}
```

`scheduledPlan` = `null` если нет запланированного тарифа.

### POST /api/webhook/prodamus

При даунгрейде с активной подпиской:
- Не меняет `plan_id` немедленно
- Устанавливает `scheduled_plan_id` и `scheduled_plan_paid_at`
- Записывает в `subscription_history` с source = `'prodamus_scheduled'`
- Возвращает `{ activated: false, scheduled: true }`

## Крон-задачи

### handleSubscriptionExpiry (09:00 MSK)

Модифицирована: перед переходом на Guest проверяет `scheduled_plan_id`:
- Если есть → активирует запланированный тариф на 30 дней
- Если нет → стандартная логика (Guest + grace period)

Source в `subscription_history`: `'scheduled_activation'`

### Расписание крон-задач (порядок критичен)

| Время (МСК) | Задача | Примечание |
|---|---|---|
| 09:00 | `handleSubscriptionExpiry` | ПЕРВОЙ — активирует scheduled планы |
| 09:05 | `handleGracePeriodExpiry` | После обработки подписок, исключает пользователей с `scheduled_plan_id` |
| 09:10 | `closeDemoPeriods` | Закрытие демо-периодов |
| 09:15 | `switchDemoToGuest` | Смена Демо → Гостевой, исключает пользователей с `scheduled_plan_id` |
| 09:20 | `deleteLockedBoardsAfter14Days` | Удаление заблокированных досок |
| 09:25 | `processDailyLocks` | Обработка Soft/Hard Lock досок |
| 09:30 | `notifyExpiringSubscriptions` | ПОСЛЕДНЕЙ — после всех изменений статусов |
| Каждый час | `cleanupOldSessions` | Техническая очистка |
| Каждый час | `cleanupExpiredVerificationCodes` | Техническая очистка |
| Каждые 5 мин | `cleanupInactiveSessions` | Автовыход неактивных сессий |
| Каждый час | Очистка `telegram_link_codes` | Техническая очистка |

### Защита от гонки крон-задач

Несколько крон-задач работают с истёкшими подписками и могут конфликтовать:

| Задача | Время | Обработка scheduled |
|--------|-------|---------------------|
| `handleSubscriptionExpiry` | 09:00 | **Единственная** задача, которая активирует `scheduled_plan_id` |
| `handleGracePeriodExpiry` | 09:05 | Безопасна: `handleSubscriptionExpiry` очищает `grace_period_until` при активации scheduled плана |
| `switchDemoToGuest` | 09:15 | Исключает пользователей с `scheduled_plan_id IS NOT NULL` |

**Правило:** только `handleSubscriptionExpiry` принимает решение о пользователях с запланированным тарифом. Остальные задачи пропускают таких пользователей через SQL-условие `AND u.scheduled_plan_id IS NULL`.

## Фронтенд

### Состояния кнопок (getPlanButtonState)

Функция `getPlanButtonState(plan)` возвращает:
- `action`: `'upgrade'` | `'renew'` | `'downgrade'` | `'current'` | `'scheduled'` | `'unavailable'`
- `label`: текст кнопки
- `disabled`: заблокирована ли кнопка
- `tooltip`: подсказка при наведении

### Цвета кнопок
- Апгрейд: стандартный (indigo)
- Продление: зелёный (#10b981)
- Даунгрейд: оранжевый (#f59e0b)
- Заблокирована: серый (#9ca3af)
- Запланирован: серый (#6b7280)

### Подтверждение даунгрейда
При нажатии кнопки даунгрейда показывается `window.confirm()` с информацией о текущем тарифе и дате перехода.

## Затронутые файлы

| Файл | Изменения |
|------|-----------|
| `api/utils/planHierarchy.js` | Новый — утилиты сравнения тарифов |
| `api/routes/prodamus.js` | Валидация в create-link |
| `api/services/prodamusService.js` | Отложенная активация в webhook |
| `api/cron/tasks.js` | Активация запланированных тарифов |
| `api/routes/plans.js` | scheduledPlan в ответе API |
| `src/stores/subscription.js` | scheduledPlan в хранилище |
| `src/composables/useUserTariffs.js` | getPlanButtonState + handleUpgrade |
| `src/views/PricingPage.vue` | Динамические кнопки, тёмная тема с золотыми акцентами (использует useUserTariffs) |
| `src/components/UserProfile.vue` | Динамические кнопки + отображение запланированного тарифа |

## Пограничные случаи

1. **Пользователь заплатил за даунгрейд, затем хочет апгрейд** — блокируется (`SCHEDULED_PLAN_EXISTS`). Нужно дождаться окончания текущей подписки.
2. **Webhook пришёл дважды** — идемпотентно: `scheduled_plan_id` просто перезаписывается тем же значением.
3. **Guest/Demo → любой платный** — всегда разрешено, немедленная активация.
4. **Запланированный тариф удалён из БД** — FK `ON DELETE SET NULL`, переход на Guest по стандартной логике.
5. **Grace period + запланированный тариф** — при активации запланированного тарифа `grace_period_until` очищается.

## История изменений

## История изменений

- 2026-02-13: Все крон-задачи с уведомлениями перенесены с ночного времени (01:00-03:00) на утреннее (09:00-09:30 МСК)
- 2026-02-13: Добавлена защита от гонки крон-задач — `switchDemoToGuest` исключает пользователей с `scheduled_plan_id IS NOT NULL`
