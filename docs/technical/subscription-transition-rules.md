# Правила перехода между тарифами

## Обзор

Система управляет переходами между тарифными планами с учётом иерархии, анти-стакинга и отложенной активации при понижении тарифа.

## Иерархия тарифов

```
guest (0) → demo (1) → individual (2) → premium (3)
бесплатно    7 дней      299 ₽/мес        499 ₽/мес
```

## Матрица переходов

| Текущий тариф | Целевой тариф | Осталось дней | Результат |
|---------------|---------------|---------------|-----------|
| Guest/Demo | Individual/Premium | любое | Немедленная активация |
| Individual | Individual | >30 | **ЗАБЛОКИРОВАНО** (рано для продления) |
| Individual | Individual | ≤30 | Продление (+30 дней от текущего окончания) |
| Individual | Premium | сумма >60 | **ЗАБЛОКИРОВАНО** (анти-стакинг) |
| Individual | Premium | сумма ≤60 | Немедленный апгрейд |
| Premium | Premium | >30 | **ЗАБЛОКИРОВАНО** (рано для продления) |
| Premium | Premium | ≤30 | Продление (+30 дней от текущего окончания) |
| Premium | Individual | >30 | **ЗАБЛОКИРОВАНО** (рано для понижения) |
| Premium | Individual | ≤30 | **Запланирован** (активируется после окончания Premium) |

## Бизнес-правила

### 1. Продление того же тарифа
- Доступно только за **30 дней** до окончания подписки
- Продлевает от текущей даты окончания + 30 дней

### 2. Апгрейд (Individual → Premium)
- Немедленная активация
- Тариф меняется сразу, оставшиеся дни конвертируются
- **Анти-стакинг:** итоговый срок не может превышать NOW + 60 дней

### 3. Даунгрейд (Premium → Individual)
- Доступен только за **30 дней** до окончания подписки
- **Отложенная активация:** Premium продолжает действовать до конца
- После окончания Premium автоматически активируется Individual на 30 дней
- Grace period НЕ начисляется при наличии запланированного тарифа

### 4. Анти-стакинг
- Нельзя купить подписку, если итоговый срок превысит **60 дней** от текущей даты
- Предотвращает накопление подписки на много месяцев вперёд

### 5. Запланированный тариф
- Блокирует любые другие покупки до активации
- Активируется автоматически крон-задачей при истечении текущей подписки
- Информация отображается в профиле пользователя

### 6. Grace Period
- Сохраняется как есть: 7 дней после окончания платного тарифа
- НЕ применяется если есть запланированный тариф

## База данных

### Новые колонки в таблице `users`

```sql
ALTER TABLE users ADD COLUMN scheduled_plan_id INTEGER
  REFERENCES subscription_plans(id) ON DELETE SET NULL;
ALTER TABLE users ADD COLUMN scheduled_plan_paid_at TIMESTAMP;
CREATE INDEX idx_users_scheduled_plan
  ON users(scheduled_plan_id) WHERE scheduled_plan_id IS NOT NULL;
```

| Колонка | Тип | Описание |
|---------|-----|----------|
| `scheduled_plan_id` | INTEGER FK | ID тарифа, ожидающего активации |
| `scheduled_plan_paid_at` | TIMESTAMP | Дата оплаты запланированного тарифа |

## API изменения

### POST /api/payments/create-link

Добавлена валидация правил перехода. Новые коды ошибок:

| Код | Описание |
|-----|----------|
| `SCHEDULED_PLAN_EXISTS` | У пользователя уже есть запланированный тариф |
| `RENEWAL_TOO_EARLY` | Продление доступно за 30 дней до окончания |
| `DOWNGRADE_TOO_EARLY` | Понижение доступно за 30 дней до окончания |
| `STACKING_LIMIT` | Итоговый срок превысит 60 дней |

### GET /api/user/plan

Новое поле в ответе:

```json
{
  "scheduledPlan": {
    "id": 6,
    "name": "Индивидуальный",
    "code_name": "individual",
    "paidAt": "2026-02-12T10:00:00Z"
  }
}
```

`scheduledPlan` = `null` если нет запланированного тарифа.

### POST /api/webhook/prodamus

При даунгрейде с активной подпиской:
- Не меняет `plan_id` немедленно
- Устанавливает `scheduled_plan_id` и `scheduled_plan_paid_at`
- Записывает в `subscription_history` с source = `'prodamus_scheduled'`
- Возвращает `{ activated: false, scheduled: true }`

## Крон-задачи

### handleSubscriptionExpiry (01:00 MSK)

Модифицирована: перед переходом на Guest проверяет `scheduled_plan_id`:
- Если есть → активирует запланированный тариф на 30 дней
- Если нет → стандартная логика (Guest + grace period)

Source в `subscription_history`: `'scheduled_activation'`

## Фронтенд

### Состояния кнопок (getPlanButtonState)

Функция `getPlanButtonState(plan)` возвращает:
- `action`: `'upgrade'` | `'renew'` | `'downgrade'` | `'current'` | `'scheduled'` | `'unavailable'`
- `label`: текст кнопки
- `disabled`: заблокирована ли кнопка
- `tooltip`: подсказка при наведении

### Цвета кнопок
- Апгрейд: стандартный (indigo)
- Продление: зелёный (#10b981)
- Даунгрейд: оранжевый (#f59e0b)
- Заблокирована: серый (#9ca3af)
- Запланирован: серый (#6b7280)

### Подтверждение даунгрейда
При нажатии кнопки даунгрейда показывается `window.confirm()` с информацией о текущем тарифе и дате перехода.

## Затронутые файлы

| Файл | Изменения |
|------|-----------|
| `api/utils/planHierarchy.js` | Новый — утилиты сравнения тарифов |
| `api/routes/prodamus.js` | Валидация в create-link |
| `api/services/prodamusService.js` | Отложенная активация в webhook |
| `api/cron/tasks.js` | Активация запланированных тарифов |
| `api/routes/plans.js` | scheduledPlan в ответе API |
| `src/stores/subscription.js` | scheduledPlan в хранилище |
| `src/composables/useUserTariffs.js` | getPlanButtonState + handleUpgrade |
| `src/views/PricingPage.vue` | Динамические кнопки |
| `src/components/UserProfile.vue` | Динамические кнопки + отображение запланированного тарифа |

## Пограничные случаи

1. **Пользователь заплатил за даунгрейд, затем хочет апгрейд** — блокируется (`SCHEDULED_PLAN_EXISTS`). Нужно дождаться окончания текущей подписки.
2. **Webhook пришёл дважды** — идемпотентно: `scheduled_plan_id` просто перезаписывается тем же значением.
3. **Guest/Demo → любой платный** — всегда разрешено, немедленная активация.
4. **Запланированный тариф удалён из БД** — FK `ON DELETE SET NULL`, переход на Guest по стандартной логике.
5. **Grace period + запланированный тариф** — при активации запланированного тарифа `grace_period_until` очищается.
