# Email Service ‚Äî –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º

## –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

`api/utils/email.js`

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- `nodemailer` ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email
- `dotenv` ‚Äî –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env)

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `EMAIL_HOST` | SMTP —Å–µ—Ä–≤–µ—Ä (smtp.beget.com) |
| `EMAIL_PORT` | –ü–æ—Ä—Ç (465 –¥–ª—è SSL) |
| `EMAIL_USER` | –õ–æ–≥–∏–Ω SMTP |
| `EMAIL_PASSWORD` | –ü–∞—Ä–æ–ª—å SMTP |
| `EMAIL_FROM` | –ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è |
| `FRONTEND_URL` | URL —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ –ø–∏—Å—å–º–∞—Ö |

## –§—É–Ω–∫—Ü–∏–∏

### `sendVerificationEmail(email, code)`

–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `email` (string) ‚Äî Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `code` (string) ‚Äî 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**–¢–µ–º–∞ –ø–∏—Å—å–º–∞:** "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Äî FOHOW"

---

### `sendPasswordResetEmail(email, token)`

–û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `email` (string) ‚Äî Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `token` (string) ‚Äî –¢–æ–∫–µ–Ω –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è

**–¢–µ–º–∞ –ø–∏—Å—å–º–∞:** "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è ‚Äî FOHOW Interactive Board"

---

### `sendWelcomeEmail(email)`

–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `email` (string) ‚Äî Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è

**–¢–µ–º–∞ –ø–∏—Å—å–º–∞:** "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FOHOW"

---

### `sendSubscriptionEmail(email, eventType, data)`

–û—Ç–ø—Ä–∞–≤–∫–∞ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Tribute.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `email` (string) ‚Äî Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `eventType` (string) ‚Äî –¢–∏–ø —Å–æ–±—ã—Ç–∏—è: `'new'`, `'renewed'`, `'cancelled'`, `'promo'`
- `data` (Object) ‚Äî –î–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:
  - `userName` (string) ‚Äî –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `planName` (string) ‚Äî –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
  - `amount` (number) ‚Äî –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã
  - `currency` (string) ‚Äî –í–∞–ª—é—Ç–∞ (–æ–±—ã—á–Ω–æ 'RUB')
  - `startDate` (string) ‚Äî –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (ISO)
  - `expiresDate` (string) ‚Äî –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (ISO)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `Promise<void>`

**–í—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç:** `Error` ‚Äî –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```javascript
import { sendSubscriptionEmail } from '../utils/email.js';

await sendSubscriptionEmail('user@example.com', 'new', {
  userName: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
  planName: 'Premium',
  amount: 399,
  currency: 'RUB',
  startDate: new Date().toISOString(),
  expiresDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
});
```

**–®–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º:**

1. **'new'** ‚Äî –ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
   - –¢–µ–º–∞: "‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚Äî FOHOW Interactive Board"
   - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ, –¥–µ—Ç–∞–ª–∏ —Ç–∞—Ä–∏—Ñ–∞, –∫–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É"

2. **'renewed'** ‚Äî –ü—Ä–æ–¥–ª–µ–Ω–∏–µ
   - –¢–µ–º–∞: "üîÑ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ ‚Äî FOHOW Interactive Board"
   - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏, –Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è

3. **'cancelled'** ‚Äî –û—Ç–º–µ–Ω–∞
   - –¢–µ–º–∞: "‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ ‚Äî FOHOW Interactive Board"
   - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–ª–∏—Ç—å

4. **'promo'** ‚Äî –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
   - –¢–µ–º–∞: "‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω | FOHOW Interactive Board"
   - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞, –¥–µ—Ç–∞–ª–∏ —Ç–∞—Ä–∏—Ñ–∞ (—Å—Ç–æ–∏–º–æ—Å—Ç—å 0 RUB), –∫–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É"
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: `data.promoCode` ‚Äî –∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–°—Ç–∏–ª—å –ø–∏—Å–µ–º:**
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω (max-width: 600px)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã (`prefers-color-scheme: dark`)
- –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ FOHOW (–∑–µ–ª—ë–Ω—ã–π #4CAF50)
- –ö–Ω–æ–ø–∫–∏ —Å –æ–∫—Ä—É–≥–ª—ã–º–∏ —É–≥–ª–∞–º–∏

---

### `sendPasswordChangedEmail(email, data)`

–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `email` (string) ‚Äî Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- `data` (Object):
  - `ipAddress` (string, optional) ‚Äî IP-–∞–¥—Ä–µ—Å, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–º–µ–Ω–∏–ª–∏ –ø–∞—Ä–æ–ª—å
  - `geo` (Object, optional) ‚Äî –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è `{country, city}` (—Å–º. `geoLocation.js`)
  - `locationString` (string, optional) ‚Äî –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–†–æ—Å—Å–∏—è, –ú–æ—Å–∫–≤–∞")
  - `changedAt` (Date, optional) ‚Äî –í—Ä–µ–º—è —Å–º–µ–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–µ–∫—É—â–µ–µ)

**–¢–µ–º–∞ –ø–∏—Å—å–º–∞:** "üîê –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω ‚Äî FOHOW Interactive Board"

**–ü—Ä–∏–º–µ—Ä:**
```javascript
import { sendPasswordChangedEmail } from '../utils/email.js';
import { getGeoLocation, formatGeoLocation } from '../utils/geoLocation.js';

const ip = '144.31.19.203';
const geo = await getGeoLocation(ip);
const locationString = formatGeoLocation(geo, ip);

await sendPasswordChangedEmail('user@example.com', {
  ipAddress: ip,
  geo,
  locationString,
  changedAt: new Date()
});
```

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–∏—Å—å–º–∞:**
- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è (–ú–°–ö)
- –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏–Ω–∞—á–µ IP-–∞–¥—Ä–µ—Å)
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ–Ω—è–ª –ø–∞—Ä–æ–ª—å

**–°—Ç–∏–ª—å:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ (#e53935) –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è
- –ñ—ë–ª—Ç—ã–π –±–ª–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏:
- `‚úÖ Email sent:` ‚Äî —É—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
- `‚ùå Email error:` ‚Äî –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

–ü—Ä–∏ –æ—à–∏–±–∫–µ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫—Ä–æ–º–µ `sendWelcomeEmail()`, –∫–æ—Ç–æ—Ä–∞—è –º–æ–ª—á–∞ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É.
