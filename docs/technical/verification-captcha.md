# Проверочный код (антибот капча)

## Описание
Система верификации для защиты форм входа и регистрации от ботов.
Генерирует 4-значный числовой код, который пользователь должен ввести перед отправкой формы.

## Расположение файлов
- Backend сервис: `api/services/emailVerificationService.js`
- Backend роут: `api/routes/auth.js` (эндпоинт `/api/verification-code`)
- Frontend (вход): `src/components/LoginForm.vue`
- Frontend (регистрация): `src/components/RegisterForm.vue`

## Как работает
1. При загрузке формы входа/регистрации автоматически запрашивается проверочный код
2. Бэкенд создаёт сессию верификации в Redis (TTL: 5 минут)
3. Возвращается `token` (для идентификации сессии) и `code` (для отображения пользователю)
4. Пользователь вводит код вручную
5. При отправке формы (логин/регистрация) токен и код передаются для валидации
6. Сессия позволяет до 5 неверных попыток ввода, после чего блокируется на 5 минут

## API эндпоинт
- `POST /api/verification-code` — генерация нового кода
  - Rate-limit: 15 запросов за 5 минут (по IP)
  - Ответ: `{ token: string, code: string }`
  - При превышении лимита: `429 { error: string, retryAfter: number }`

## Технические детали
- Хранение сессий: Redis (ioredis)
- TTL сессии: 5 минут (`VERIFICATION_CODE_TTL_SECONDS`)
- Максимум попыток ввода: 5 (`VERIFICATION_MAX_ATTEMPTS`)
- Блокировка после превышения: 5 минут (`VERIFICATION_LOCK_DURATION_SECONDS`)
- Cooldown кнопки "Обновить код" на фронтенде: 5 секунд

## Настройки rate-limit
| Параметр | Значение | Описание |
|----------|----------|----------|
| max | 15 | Максимум запросов за окно |
| timeWindow | 5 minutes | Временное окно |
| Тип ограничения | По IP | Стандарт @fastify/rate-limit |

## UX-поведение при rate-limit
- При получении 429 ответа показывается **информационное** (синее) сообщение вместо ошибки (красного)
- Текст: "Слишком частые запросы. Обновление кода будет доступно через Xс"
- Кнопка "Обновить код" блокируется на время `retryAfter` с обратным отсчётом
- Если код не загрузился при открытии страницы (429) — в блоке кода отображается `••••`
- После истечения таймера rate-limit код запрашивается автоматически

## История изменений
- 2025-02-07: Cooldown уменьшен с 10с до 5с, добавлено информационное (синее) сообщение при rate-limit вместо красной ошибки, авто-запрос кода после истечения таймера, fallback `••••` для пустого кода
- 2025-02-07: Увеличен rate-limit с max:3 до max:15, добавлен cooldown на фронтенде, улучшено логирование ошибок в GLOBAL ERROR HANDLER, обновлена Swagger schema для 429 ответа с полем retryAfter
