# Проверочный код (антибот капча)

## Описание
Система верификации для защиты форм входа и регистрации от ботов.
Генерирует 4-значный числовой код, который пользователь должен ввести перед отправкой формы.

## Расположение файлов
- Backend сервис: `api/services/emailVerificationService.js`
- Backend роут: `api/routes/auth.js` (эндпоинт `/api/verification-code`)
- Frontend (вход): `src/components/LoginForm.vue`
- Frontend (регистрация): `src/components/RegisterForm.vue`

## Как работает
1. При загрузке формы входа/регистрации автоматически запрашивается проверочный код
2. Бэкенд создаёт сессию верификации в Redis (TTL: 5 минут)
3. Возвращается `token` (для идентификации сессии) и `code` (для отображения пользователю)
4. Пользователь вводит код вручную
5. При отправке формы (логин/регистрация) токен и код передаются для валидации
6. Сессия позволяет до 5 неверных попыток ввода, после чего блокируется на 5 минут

## API эндпоинт
- `POST /api/verification-code` — генерация нового кода
  - Rate-limit: 15 запросов за 5 минут (по IP)
  - Ответ: `{ token: string, code: string }`
  - При превышении лимита: `429 { error: string, retryAfter: number }`

## Технические детали
- Хранение сессий: Redis (ioredis)
- TTL сессии: 5 минут (`VERIFICATION_CODE_TTL_SECONDS`)
- Максимум попыток ввода: 5 (`VERIFICATION_MAX_ATTEMPTS`)
- Блокировка после превышения: 5 минут (`VERIFICATION_LOCK_DURATION_SECONDS`)
- Cooldown кнопки "Обновить код" на фронтенде: 5 секунд
- Rate-limit ошибки обрабатываются GLOBAL ERROR HANDLER отдельно — пробрасываются как 429 с полем `retryAfter` (определяются по отсутствию `.stack` и наличию `.retryAfter`)

## Настройки rate-limit
| Параметр | Значение | Описание |
|----------|----------|----------|
| max | 15 | Максимум запросов за окно |
| timeWindow | 5 minutes | Временное окно |
| Тип ограничения | По IP | Стандарт @fastify/rate-limit |

## Логика cooldown и rate-limit

### Сценарий 1: Ручное обновление кода (кнопка "Обновить код")
- Пользователь нажимает "Обновить код"
- Кнопка показывает счётчик: "Обновить код (5с)" → "Обновить код (4с)" → ... → "Обновить код"
- После 5 секунд кнопка снова активна

### Сценарий 2: Rate-limit от сервера (429)
- Сервер возвращает 429 с `retryAfter: N`
- Показывается информационное сообщение (синий фон): "Слишком частые запросы. Обновление кода будет доступно через N сек."
- Счётчик в сообщении **тикает в реальном времени**: 215 → 214 → 213 → ...
- Кнопка "Обновить код" disabled (без счётчика в кнопке — счётчик только в сообщении)
- Если код не загрузился при открытии страницы (429) — в блоке кода отображается `••••`
- Когда таймер достигает 0 — автоматически запрашивается новый код

## История изменений
- 2025-02-07: Исправлен тикающий счётчик в info-сообщении при rate-limit, кнопка показывает "(Nс)" только при ручном cooldown (не при rate-limit)
- 2025-02-07: GLOBAL ERROR HANDLER исправлен — rate-limit объекты из errorResponseBuilder теперь пробрасываются как 429, остальные ошибки используют error.statusCode вместо хардкода 500
- 2025-02-07: Cooldown уменьшен с 10с до 5с, добавлено информационное (синее) сообщение при rate-limit вместо красной ошибки, авто-запрос кода после истечения таймера, fallback `••••` для пустого кода
- 2025-02-07: Увеличен rate-limit с max:3 до max:15, добавлен cooldown на фронтенде, улучшено логирование ошибок в GLOBAL ERROR HANDLER, обновлена Swagger schema для 429 ответа с полем retryAfter
