# –°–∫—Ä–∏–ø—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

–≠—Ç–∞ –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á.

## downgrade_expired.js

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–Ω–∏–∂–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ –¥–æ Guest –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ–∫—à–∏–º grace-–ø–µ—Ä–∏–æ–¥–æ–º.

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
2. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö:
   - –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ (`subscription_expires_at < NOW()`)
   - Grace-–ø–µ—Ä–∏–æ–¥ –∏—Å—Ç–µ–∫ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (`grace_period_until IS NULL OR grace_period_until < NOW()`)
   - –¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ –Ω–µ Guest (`plan_id != guest`)
3. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∏—Ö –Ω–∞ —Ç–∞—Ä–∏—Ñ **Guest**
4. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–æ—Å–æ–∫
5. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

```bash
# –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
node scripts/downgrade_expired.js
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ CRON

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ crontab —Å–µ—Ä–≤–µ—Ä–∞:

```bash
# –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00 —É—Ç—Ä–∞
0 3 * * * cd /path/to/FOHOW-proekt-v3 && node scripts/downgrade_expired.js >> /var/log/fohow/downgrade_expired.log 2>&1
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ CRON —Å—Ç—Ä–æ–∫–∏:**
- `0 3 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 —É—Ç—Ä–∞
- `cd /path/to/FOHOW-proekt-v3` - –ø–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
- `node scripts/downgrade_expired.js` - –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
- `>> /var/log/fohow/downgrade_expired.log` - –∑–∞–ø–∏—Å—å –ª–æ–≥–æ–≤ –≤ —Ñ–∞–π–ª
- `2>&1` - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Ç–æ—Ç –∂–µ –ª–æ–≥-—Ñ–∞–π–ª

**–î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:**

```bash
# –ö–∞–∂–¥—ã–π —á–∞—Å
0 * * * * cd /path/to/project && node scripts/downgrade_expired.js >> /var/log/fohow/downgrade.log 2>&1

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
0 0 * * * cd /path/to/project && node scripts/downgrade_expired.js >> /var/log/fohow/downgrade.log 2>&1

# –ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 2:00
0 2 * * 0 cd /path/to/project && node scripts/downgrade_expired.js >> /var/log/fohow/downgrade.log 2>&1

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00, 9:00 –∏ 15:00
0 3,9,15 * * * cd /path/to/project && node scripts/downgrade_expired.js >> /var/log/fohow/downgrade.log 2>&1
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CRON –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ crontab –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
   ```bash
   crontab -e
   ```

2. –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º

3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –∑–∞–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞:
   ```bash
   crontab -l
   ```

5. –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç):
   ```bash
   sudo mkdir -p /var/log/fohow
   sudo chown $USER:$USER /var/log/fohow
   ```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–µ—Ç–∞–ª—è–º–∏
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- ‚ùå –û—à–∏–±–∫–∏ (–µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏)

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:

```
========================================
üîÑ –°–∫—Ä–∏–ø—Ç: –ü–æ–Ω–∏–∂–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –¥–ª—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
‚è∞ –ó–∞–ø—É—Å–∫: 2025-01-15T03:00:00.000Z
========================================

‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

üìã –ü–æ–∏—Å–∫ —Ç–∞—Ä–∏—Ñ–∞ Guest...
‚úÖ –ù–∞–π–¥–µ–Ω —Ç–∞—Ä–∏—Ñ: "Guest" (ID: 5)

üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ–∫—à–∏–º grace-–ø–µ—Ä–∏–æ–¥–æ–º...
üìä –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–Ω–∏–∂–µ–Ω–∏—è: 3

üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
  1. user1@example.com (Ivan)
     –¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π (individual)
     –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞: 2025-01-08T00:00:00.000Z
     Grace-–ø–µ—Ä–∏–æ–¥ –¥–æ: 2025-01-15T00:00:00.000Z

...

üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤...
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: 3

========================================
üìä –ò–¢–û–ì–ò –í–´–ü–û–õ–ù–ï–ù–ò–Ø:
   –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 3
   –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: 3
   –ù–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ: Guest (ID: 5)
   –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 2025-01-15T03:00:01.234Z
========================================

‚úÖ –°–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js >= 20.19.0
- –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
- –§–∞–π–ª `api/.env` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:
  ```env
  DB_HOST=localhost
  DB_PORT=5432
  DB_NAME=your_database
  DB_USER=your_user
  DB_PASSWORD=your_password
  ```

**–í–∞–∂–Ω–æ:** –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ `api/.env`. –ï—Å–ª–∏ —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, —Å–∫—Ä–∏–ø—Ç –≤—ã–≤–µ–¥–µ—Ç –æ—à–∏–±–∫—É –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–∞–∂–Ω–æ:**
- –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è (ROLLBACK)
- –°–∫—Ä–∏–ø—Ç –ù–ï —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ—Ç —Ç–∞—Ä–∏—Ñ
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î –ø–µ—Ä–µ–¥ –º–∞—Å—Å–æ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º

### –°–≤—è–∑—å —Å CRON –∑–∞–¥–∞—á–∞–º–∏

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑ `api/cron/tasks.js` (–∑–∞–¥–∞—á–∞ `handleSubscriptionExpiry`), –Ω–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è:
- –†—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- –û—Ç–¥–µ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ CRON
- –û—Ç–ª–∞–¥–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–∏–≥—Ä–∞—Ü–∏–π

–ï—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç `api/cron/tasks.js`, –º–æ–∂–Ω–æ –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π CRON –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞.
